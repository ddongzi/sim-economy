{% extends "layout.html" %}

{% block content %}
<style>
    /* ç®€å•çš„æ°”æ³¡æ ·å¼æå‡ä½“éªŒ */
    .msg-box {
        margin-bottom: 10px;
        max-width: 85%;
        padding: 8px 12px;
        border-radius: 10px;
        font-size: 0.95rem;
    }

    .msg-received {
        background: #fff;
        border: 1px solid #dee2e6;
    }

    .msg-sent {
        background: #cfe2ff;
        margin-left: auto;
        border: 1px solid #b6d4fe;
    }

    .msg-private {
        border-left: 4px solid #ffc107;
    }

    /* ç§èŠæ¶ˆæ¯é«˜äº®é»„è¾¹ */
    .msg-meta {
        font-size: 0.75rem;
        color: #6c757d;
        margin-bottom: 2px;
    }
</style>
<div class="container-fluid py-3 ">
    <div class="row g-3">
        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-dark text-white fw-bold small">é€šè®¯ä¸­å¿ƒ</div>
                <div class="list-group list-group-flush" id="chat-targets">
                    <button class="list-group-item list-group-item-action active d-flex justify-content-between align-items-center"
                            onclick="gameChat.setTarget('global', this)">
                        ğŸŒ å…¨å±€é¢‘é“
                        <!-- çº¢ç‚¹å ä½ï¼šåˆå§‹çŠ¶æ€é€šè¿‡ d-none éšè— -->
                        <span class="badge bg-danger border border-light rounded-circle p-1 d-none" id="unread-Global">
                    </span>
                    </button>

                    <div id="online-users"></div>
                </div>
            </div>
        </div>

        <div class="col-md-9">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <span class="fw-bold" id="current-target-display">æ­£åœ¨å‘é€åˆ°: å…¨å±€å¤§å…</span>
                    <span class="badge bg-success" id="connection-status">å·²è¿æ¥</span>
                </div>

                <div class="card-body p-0">
                    <div id="chat-window" class="p-3 bg-light overflow-auto" style="height: 450px;">
                    </div>
                </div>

                <div class="card-footer bg-white border-top-0">
                    <div class="input-group">
                        <input type="text" id="chat-input" class="form-control" placeholder="è¾“å…¥æ¶ˆæ¯..."
                               autocomplete="off">
                        <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal"
                                data-bs-target="#contractModal">
                            ğŸ“œ
                        </button>
                        <button class="btn btn-primary px-4" onclick="gameChat.send()">å‘é€</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="contractModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="card bg-dark text-white border-primary shadow">
            <div class="card-header fw-bold">ğŸ“œ å‘èµ·ç°è´§åˆåŒ</div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="small text-secondary">èµ„æºç±»å‹</label>
                    <select id="item-type" class="form-select bg-secondary text-white border-0">
                        <option value="é’¢é“">é’¢é“</option>
                        <option value="ç²®é£Ÿ">ç²®é£Ÿ</option>
                        <option value="çŸ³æ²¹">çŸ³æ²¹</option>
                    </select>
                </div>
                <div class="row g-2">
                    <div class="col-6"><input type="number" id="item-qty" class="form-control" placeholder="æ•°é‡"></div>
                    <div class="col-6"><input type="number" id="item-price" class="form-control" placeholder="å•ä»·">
                    </div>
                </div>
            </div>
            <div class="card-footer text-end">
                <button class="btn btn-sm btn-outline-light" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button class="btn btn-sm btn-primary" onclick="gameChat.sendContract()">å‘é€åˆåŒ</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}


{% block scripts %}
<script>
    class ChatService {
        constructor() {
            this.target = "global"; // é»˜è®¤å‘é€ç›®æ ‡
            this.chatWindow = document.getElementById('chat-window');
            this.input = document.getElementById('chat-input');
            this.bindEvents();

            this.type = "chat"
        }

        // åˆ‡æ¢é¢‘é“çš„æ–¹æ³•ï¼šç‚¹å‡»å·¦ä¾§åˆ—è¡¨æ—¶è§¦å‘
        setTarget(name, element) {
            this.target = name;

            // UI åˆ‡æ¢é«˜äº®çŠ¶æ€
            document.querySelectorAll('#chat-targets .list-group-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
            document.querySelector("#current-target-display").innerText = `æ­£åœ¨å‘é€åˆ°ï¼š${name}`

            this.chatWindow.innerHTML = '';
            // éšè—çº¢ç‚¹ï¼ˆæ¯”å¦‚ç‚¹å‡»è¯¥ç”¨æˆ·åï¼‰
            document.getElementById(`unread-${name}`).classList.add('d-none');
        }

        send() {
            const text = this.input.value.trim();
            if (text) {
                const payload = {
                    to: this.target,
                    from: getUserInfo().name,
                    message: text
                };
                const subtype = this.target === 'global' ? 'global' : 'private';
                gameWS.send(this.type, subtype, JSON.stringify(payload));
                this.input.value = '';
            }
        }

        // {
        //     type: type,
        //     sub_type: subType,
        //     data: payload,
        //     timestamp: Date.now()
        // }
        handleIncomingMessage(msg) {
            // 1. å¤„ç†ç³»ç»Ÿå‘é€çš„åœ¨çº¿åˆ—è¡¨æ›´æ–°
            const userInfo = getUserInfo()
            const sub_type = msg.sub_type;
            const data = msg.data

            // 2. ç¡®å®šæ¶ˆæ¯åº”è¯¥å½’å±äºå“ªä¸ªâ€œé¢‘é“/æ§½ä½â€ (chatKey)
            // å¦‚æœæ˜¯ç¾¤èŠï¼Œå½’å±äº 'Global'ï¼›å¦‚æœæ˜¯ç§èŠï¼Œå½’å±äºâ€œå¯¹æ–¹çš„åå­—â€
            const chatKey = sub_type === 'global'
                ? 'global'
                : (data.from === userInfo.name ? data.to : data.from);

            // 4. UI æ¸²æŸ“é€»è¾‘åˆ†æµ
            console.log("", this.target, chatKey)
            if (this.target === chatKey) {
                // åœºæ™¯ Aï¼šç©å®¶æ­£åœ¨çœ‹ç€è¿™ä¸ªé¢‘é“ -> ç›´æ¥æŠŠæ¶ˆæ¯åˆ·åˆ°å±å¹•ä¸Š
                const isMine = data.from === userInfo.name;
                this.appendMessage(data, isMine);
            } else {
                // åœºæ™¯ Bï¼šç©å®¶åœ¨çœ‹åˆ«çš„é¢‘é“ -> åœ¨ä¾§è¾¹æ å¯¹åº”çš„åå­—ä¸Šæ˜¾ç¤ºæœªè¯»çº¢ç‚¹/æ•°å­—
                document.getElementById(`unread-${chatKey}`).classList.remove('d-none');
            }
        }

        appendMessage(data, isMine) {
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
            const isPrivate = data.type === 'private';

            const html = `
            <div class="d-flex flex-column ${isMine ? 'align-items-end' : 'align-items-start'} mb-2">
                <div class="msg-meta">${data.from} â€¢ ${time} ${isPrivate ? '<span class="text-warning">[ç§èŠ]</span>' : ''}</div>
                <div class="msg-box ${isMine ? 'msg-sent' : 'msg-received'} ${isPrivate ? 'msg-private' : ''}">
                    ${this.escapeHtml(data.message)}
                </div>
            </div>
        `;
            this.chatWindow.insertAdjacentHTML('beforeend', html);
            this.chatWindow.scrollTop = this.chatWindow.scrollHeight;
        }


        escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        bindEvents() {
            this.input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') this.send();
            });
        }


    }

    function renderUserList() {
        const users = JSON.parse(localStorage.getItem('user_list'))
        console.log(users)
        const container = document.getElementById('online-users');
        container.innerHTML = users
            .filter(u => u !== getUserInfo().name)
            .map(u => `
                <button class="list-group-item list-group-item-action small py-2" onclick="gameChat.setTarget('${u}', this)">
                    ğŸ‘¤ ${u}
                <!-- çº¢ç‚¹å ä½ï¼šåˆå§‹çŠ¶æ€é€šè¿‡ d-none éšè— -->
                    <span class="badge bg-danger border border-light rounded-circle p-1 d-none" id="unread-${u}">
                        <span class="visually-hidden">New message</span>
                    </span>
                </button>
            `).join('');
    }

    let gameChat;
    document.addEventListener("DOMContentLoaded", async () => {
        // åˆå§‹åŒ–
        console.log("init chat ml")
        console.log(gameWS)
        const userInfo = getUserInfo()
        localStorage.removeItem("user_list")
        gameChat = new ChatService();
        gameWS.subscribe(gameChat.type, (data) => gameChat.handleIncomingMessage(data))
        gameWS.subscribe("user_list_update", (msg) => {
            localStorage.setItem("user_list", JSON.stringify(msg.data))
            renderUserList();
        })
    })
</script>

{% endblock %}
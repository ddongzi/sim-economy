<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimEcon</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body class=" d-flex align-items-center justify-content-center">
<div class="container-fluid bg-secondary-subtle bg-gradient vh-100 d-flex align-items-center justify-content-center bg-light">
    <div class="row shadow-lg g-0 bg-white overflow-hidden rounded-4" style="max-width: 900px; min-height: 500px;">

        <!-- 左侧：系统信息栏 (Sidebar) -->
        <div class="col-md-5 d-none d-md-flex flex-column justify-content-between p-5 bg-dark text-white border-end">
            <div>
                <h1 class="display-6 fw-bold mb-1">SimEcon.</h1>
                <p class="small text-secondary tracking-widest text-uppercase">Macroeconomic Simulation</p>
            </div>

            <div id="quoteContainer">
                <p class="fst-italic lh-base mb-2">“在这个世界上，除了死亡和税收以外，没有什么是确定的。”</p>
                <p class="small text-secondary text-end">— 本杰明·富兰克林</p>
            </div>

            <div class="small opacity-50 font-monospace">
                SYSTEM STATUS: ONLINE // v3.0
            </div>
        </div>

        <!-- 右侧：交互区 (Login/Register Box) -->
        <div class="col-md-7 p-5">
            <ul class="nav nav-underline mb-5 justify-content-start" id="authTab" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active text-dark fw-bold" onclick="toggleForm('login', this)">登录存档
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link text-muted" onclick="toggleForm('reg', this)">初始化档案</button>
                </li>
            </ul>

            <!-- 登录表单 -->
            <form id="loginForm">
                <div class="mb-3">
                    <label class="form-label small fw-semibold text-secondary">名字 / ID</label>
                    <input type="text" class="form-control form-control-lg bg-light border-0" placeholder="name"
                           required>
                </div>
                <div class="mb-4">
                    <label class="form-label small fw-semibold text-secondary">访问密码</label>
                    <input type="password" class="form-control form-control-lg bg-light border-0" placeholder="••••••••"
                           required>
                </div>
                <button type="submit" class="btn btn-dark btn-lg w-100 shadow-sm mb-3">进入</button>
            </form>

            <!-- 注册表单 (初始隐藏) -->
            <form id="registerForm" class="d-none">
                <div class="mb-3">
                    <label class="form-label small fw-semibold text-secondary">名字</label>
                    <input type="text" class="form-control bg-light border-0" placeholder="新名称" name="name">
                </div>
                <div class="mb-3">
                    <label class="form-label small fw-semibold text-secondary">邮箱</label>
                    <input type="email" class="form-control bg-light border-0" placeholder="name@network.com" name="email">
                </div>
                <div class="mb-4">
                    <label class="form-label small fw-semibold text-secondary">设定密钥</label>
                    <input type="password" class="form-control bg-light border-0" placeholder="密码" name="password">
                </div>
                <button type="submit" class="btn btn-dark  btn-lg w-100 shadow-sm mb-3">注册</button>
            </form>

            <div class="text-center mt-5">
                <hr class="text-muted opacity-25">
                <p class="text-muted" style="font-size: 0.65rem;">&copy; 2026 基于经济实况模拟引擎构建 // 核心：[]</p>
            </div>
        </div>
    </div>
</div>

<script>
    function toggleForm(type, btn) {
        const loginForm = document.getElementById('loginForm');
        const regForm = document.getElementById('registerForm');
        const tabs = document.querySelectorAll('.nav-link');

        // 切换按钮激活状态
        tabs.forEach(t => t.classList.remove('active', 'text-dark', 'fw-bold'));
        tabs.forEach(t => t.classList.add('text-muted'));
        btn.classList.add('active', 'text-dark', 'fw-bold');
        btn.classList.remove('text-muted');

        if (type === 'login') {
            loginForm.classList.remove('d-none');
            regForm.classList.add('d-none');
        } else {
            loginForm.classList.add('d-none');
            regForm.classList.remove('d-none');
        }
    }
</script>

<script>
    /**
     * SimEcon 认证系统逻辑 (同步最新 HTML 结构)
     */

    document.addEventListener('DOMContentLoaded', function () {
        const API_BASE = "/api/player";

        // 1. 处理登录请求
        const loginForm = document.getElementById('loginForm');
        if (loginForm) {
            loginForm.onsubmit = async (e) => {
                e.preventDefault();

                // 对应最新 HTML 中的输入框（通常通过 name 获取，或者你手动给 input 加 id）
                const nameInput = loginForm.querySelector('input[type="text"]');
                const passInput = loginForm.querySelector('input[type="password"]');

                const payload = {
                    name: nameInput.value,
                    // 如果后端需要密码字段，请确保 payload 包含 password
                    password: passInput.value
                };

                try {
                    const response = await fetch(`${API_BASE}/login`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload),
                        credentials: 'include'
                    });

                    if (response.ok) {
                        // 登录成功，重定向至地理景观/演化层
                        window.location.href = '/landscape';
                    } else {
                        const err = await response.json();
                        alert("接入失败: " + (err.detail || "主体识别码或密钥错误"));
                    }
                } catch (err) {
                    console.error("网络异常:", err);
                    alert("无法连接至模拟引擎，请检查节点状态");
                }
            };
        }

        // 2. 处理注册请求 (初始化档案)
        const registerForm = document.getElementById('registerForm');
        if (registerForm) {
            registerForm.onsubmit = async (e) => {
                e.preventDefault();

                const nameInput = registerForm.querySelector('input[name="name"]');
                const emailInput = registerForm.querySelector('input[type="email"]');
                const passInput = registerForm.querySelector('input[type="password"]');

                const payload = {
                    name: nameInput.value,
                    email: emailInput.value,
                    password: passInput.value
                };

                try {
                    const response = await fetch(`${API_BASE}/register`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        // 模拟点击切换回登录标签
                        const loginTab = document.querySelector('button[onclick*="login"]');
                        if (loginTab) loginTab.click();
                    } else {
                        const err = await response.json();
                        alert("初始化失败: " + (err.detail || "该标识符已在演化库中存在"));
                    }
                } catch (err) {
                    console.error("请求异常:", err);
                    alert("数据同步中断，请检查通讯链路");
                }
            };
        }
    });

    /**
     * 辅助功能：自动检测环境接入状态
     */
    async function checkAuthOnLoad() {
        try {
            // 使用 [Fetch API](https://developer.mozilla.org) 检查状态
            const response = await fetch("/api/player/me", {credentials: 'include'});
            if (response.ok) {
                window.location.href = '/landscape';
            }
        } catch (e) {
            console.log("未检测到活跃的模拟会话");
        }
    }

    // 如果需要自动跳转，取消下面注释
    // window.onload = checkAuthOnLoad;

</script>
</body>
</html>
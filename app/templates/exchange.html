{% extends "layout.html" %}

{% block content %}
<div class="container-fluid py-3">
    <div class="row g-3">

        <div class="col-xxl-2 col-lg-3">
            <div class="card shadow-sm border-0 mb-3">
                <div class="card-header bg-primary text-white py-3">
                    <h6 class="mb-0 fw-bold"><i class="bi bi-bank2 me-2"></i> 行业板块</h6>
                </div>
                <div id="resource-category-list" class="list-group list-group-flush small overflow-auto"
                     style="max-height: 80vh;">
                </div>
            </div>
        </div>

        <div class="col-xxl-10 col-lg-9">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-0 fw-bold">交易所</h4>
                        <span class="badge bg-info text-dark">品质: 任意 (All Quality)</span>
                    </div>
                    <div class="text-end d-flex align-items-center justify-content-end gap-3">
                        <!-- 最新市价组 -->
                        <div class="lh-1">
                            <small class="text-muted me-1">最新市价</small>
                            <span class="fs-4 fw-bold text-success" id="least_market_price">$0.000</span>
                        </div>

                        <!-- 垂直分割线（可选） -->
                        <div class="border-start ps-3 lh-1">
                            <small class="text-muted me-1">基准价格</small>
                            <span class="small fw-bold text-secondary" id="base_price">$0.000</span>
                        </div>
                    </div>


                </div>

                <div class="card-body p-0">
                    <div class="row g-0 ">
                        <div class="col-md-6 border-end orderbook-ask">
                            <div class="p-2 bg-danger bg-opacity-10 text-danger small fw-bold text-center">卖单 (Asks) -
                                供应
                            </div>
                            <table class="table table-hover table-sm mb-0 text-end">
                                <thead class="small text-muted">
                                <tr>
                                    <th class="text-start ps-3">品质</th>
                                    <th>单价</th>
                                    <th class="pe-3">总量</th>
                                </tr>
                                </thead>
                                <tbody>

                                </tbody>
                            </table>
                        </div>

                        <div class="col-md-6 orderbook-bid">
                            <div class="p-2 bg-success bg-opacity-10 text-success small fw-bold text-center">买单 (Bids)
                                - 需求
                            </div>
                            <table class="table table-hover table-sm mb-0">
                                <thead class="small text-muted">
                                <tr>
                                    <th class="ps-3">总量</th>
                                    <th>单价</th>
                                    <th class="text-end pe-3">品质</th>
                                </tr>
                                </thead>
                                <tbody>

                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card-footer bg-light border-0 py-3">
                    <form class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label class="small fw-bold">下单类型</label>
                            <select class="form-select form-select-sm">
                                <option>限价买入 (Limit Buy)</option>
                                <option>限价卖出 (Limit Sell)</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="small fw-bold">品质 (Q)</label>
                            <input type="number" class="form-control form-control-sm" value="0" min="0" max="5">
                        </div>
                        <div class="col-md-3">
                            <label class="small fw-bold">单价 ($)</label>
                            <input type="number" class="form-control form-control-sm" step="0.001" value="0.000">
                        </div>
                        <div class="col-md-2">
                            <label class="small fw-bold">数量</label>
                            <input type="number" class="form-control form-control-sm" placeholder="0">
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary btn-sm w-100"
                                    id="submitOrderBtn">提交委托
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>


    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function renderResourceSidebar() {
        const container = document.getElementById('resource-category-list');
        const resources = window.gameData.resources;

        // 1. 按照行业 (industry) 分组
        // 如果你的数据字段不是 industry，请替换为对应的键名（如 category）
        const grouped = resources.reduce((acc, res) => {
            const category = res.industry_id || '未分类';
            if (!acc[category]) acc[category] = [];
            acc[category].push(res);
            return acc;
        }, {});

        // 2. 映射分组数据生成带有标题的 HTML
        const html = Object.entries(grouped).map(([category, items]) => {

            const itemsHtml = items.map(res => {
                const isActive = false; // 根据逻辑设置
                return `
                <button
                    class="btn btn-light d-flex align-items-center
                           px-2 py-1 small ${isActive ? 'active' : ''}"
                    onclick="selectExchangeResource(${res.id})"
                    data-res-id="${res.id}"
                    title="ID: ${res.id}">

                    <span class="d-flex align-items-center gap-1">
                        ${renderIcon(res.icon)}
                        <span class="fw-medium">${res.name}</span>
                    </span>
                </button>
            `;

            }).join('');

            return `
<div class="resource-group mb-3">
    <div class="px-3 py-2 fw-bold small text-muted bg-light border-bottom">
        ${category}
    </div>

    <div class="d-flex flex-wrap gap-2 px-2 py-2">
        ${itemsHtml}
    </div>
</div>
`;
        }).join('');

        container.innerHTML = html;
    }


    function selectExchangeResource(resourceId) {
        // 1. 找到之前那个 active 的元素，把它打回原形
        console.log("Selecet exchange change", resourceId)
        const prevActive = document.querySelector('#resource-category-list .active');
        if (prevActive) {
            prevActive.classList.remove('active');
            // 如果你有 badge 变色逻辑，也在这里改
            const badge = prevActive.querySelector('.badge');
            if (badge) {
                badge.classList.replace('bg-white', 'bg-light');
                badge.classList.add('text-muted');
            }
        }

        // 2. 找到当前被点击的元素，给它穿上 active 外衣
        // 使用属性选择器精准定位 data-res-id
        const current = document.querySelector(`#resource-category-list [data-res-id="${resourceId}"]`);
        if (current) {
            current.classList.add('active');
            const badge = current.querySelector('.badge');
            if (badge) {
                badge.classList.replace('bg-light', 'bg-white');
                badge.classList.remove('text-muted');
            }
        }
        // 3. 更新全局变量 & 触发数据请求
        gameWS.send("exchange", "switch_resource", JSON.stringify({
            "resource_id": resourceId
        }))
    }

    /**
     * 动态渲染盘口数据
     * @param {Array} orders - 从后端 CRUD 接口获取的订单数组
     */
    async function renderOrderBook(data) {
        console.log("render order book", data)
        const resource_id = data["resource_id"]
        let res = await fetch(`/api/exchange/simple/${resource_id}`);
        let price = await res.json()
        document.querySelector("#least_market_price").innerText = `$${price["market_price"]}`
        document.querySelector("#base_price").innerText = `$${price["base_price"]}`

        const orders = data['orders']

        const askBody = document.querySelector('.orderbook-ask').querySelector('tbody');
        const bidBody = document.querySelector('.orderbook-bid').querySelector('tbody');

        // 获取当前玩家 ID
        res = await fetch("/api/player/me");
        const player = await res.json();
        const myId = player.id;

        // 1. 数据拆分与排序
        const asks = orders['asks']
        const bids = orders['bids']

        // 2. 渲染卖单 (Asks)
        askBody.innerHTML = asks.slice(0, 10).map(order => {
            const isMine = order.player_id === myId;
            // 如果是自己的订单，背景微黄，价格加粗
            const rowClass = isMine ? 'table-warning shadow-sm' : '';
            const mineBadge = isMine ? '<span class="badge bg-danger p-1" style="font-size:0.5rem">MINE</span>' : '';

            return `
            <tr class="cursor-pointer ${rowClass}" onclick="fillOrderForm('buy', ${order.price_per_unit}, ${order.quality})">
                <td class="text-start ps-3 text-muted">Q0 ${mineBadge} ${order.id}</td>
                <td class="fw-bold ${isMine ? 'text-dark' : 'text-danger'}">$${order.price_per_unit.toFixed(3)}</td>
                <td class="pe-3">${(order.quantity).toLocaleString()}</td>
            </tr>
        `;
        }).join('') || '<tr><td colspan="3" class="text-center text-muted small py-3">暂无供应</td></tr>';

        // 3. 渲染买单 (Bids)
        bidBody.innerHTML = bids.slice(0, 10).map(order => {
            const isMine = order.player_id === myId;
            const rowClass = isMine ? 'table-warning shadow-sm' : '';
            const mineBadge = isMine ? '<span class="badge bg-success p-1" style="font-size:0.5rem">MINE</span>' : '';

            return `
            <tr class="cursor-pointer ${rowClass}" onclick="fillOrderForm('sell', ${order.price_per_unit}, ${order.quality})">
                <td class="ps-3">${(order.quantity).toLocaleString()}</td>
                <td class="fw-bold ${isMine ? 'text-dark' : 'text-success'}">$${order.price_per_unit.toFixed(3)}</td>
                <td class="text-end pe-3 text-muted">${order.id} ${mineBadge} Q0 </td>
            </tr>
        `;
        }).join('') || '<tr><td colspan="3" class="text-center text-muted small py-3">暂无需求</td></tr>';
    }

    document.addEventListener('DOMContentLoaded', async () => {
        await window.gameDataPromise
        renderResourceSidebar();

    });

</script>
<script>

</script>
<script>

    document.addEventListener('DOMContentLoaded', async () => {
        await window.gameDataPromise
        const btn = document.getElementById('submitOrderBtn');
        if (btn) {
            btn.addEventListener('click', async (event) => {
                // 1. 阻止表单默认提交行为
                event.preventDefault();

                // 2. 获取表单引用
                const form = event.target.closest('form');

                // 3. 提取数据（根据你的 HTML 结构顺序）
                const orderTypeRaw = form.querySelector('select').value;
                const quality = parseInt(form.querySelectorAll('input')[0].value);
                const price = parseFloat(form.querySelectorAll('input')[1].value);
                const quantity = parseInt(form.querySelectorAll('input')[2].value);

                const resId = document.querySelector("#resource-category-list .active")?.dataset.resId;
                if (!resId) {
                    alert("请先选择要生产的资源！");
                    return;
                }
                // 4. 数据预处理与验证 (数学逻辑校验)
                const isBuy = orderTypeRaw.includes("买入");
                const orderType = isBuy ? "buy" : "sell";

                if (isNaN(quantity) || quantity <= 0) {
                    alert("请输入有效的委托数量");
                    return;
                }
                if (price <= 0) {
                    alert("单价必须大于 0");
                    return;
                }

                // 5. UI 状态锁定
                const btn = form.querySelector('button');
                const originalText = btn.innerText;
                btn.disabled = true;
                btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> 处理中...`;

                try {
                    // 6. 发送异步请求给 FastAPI 后端
                    const response = await fetch('/api/exchange/order', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            resource_id: resId, // 假设你知道当前在交易什么
                            order_type: orderType,
                            quality: quality,
                            price_per_unit: price,
                            quantity: quantity,
                            created_at: new Date().toISOString()
                        })
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.detail || '提交委托失败');
                    }

                    // 7. 成功提示并刷新数据
                    alert(`委托提交成功！类型：${orderTypeRaw}`);

                    // 触发你之前写的库存和任务渲染函数
                    if (typeof fetchAndRenderInventory === 'function') fetchAndRenderInventory(window.currentUser.id);
                    if (typeof refreshMarketOrders === 'function') refreshMarketOrders(); // 刷新挂单列表

                } catch (error) {
                    alert(`错误: ${error.message}`);
                } finally {
                    // 8. 恢复按钮
                    btn.disabled = false;
                    btn.innerText = originalText;
                }
            });
        }
    });

</script>

<script>

    let gameExchange;
    document.addEventListener("DOMContentLoaded", async () => {
        // 初始化
        gameWS.subscribe("exchange", (msg) => {
            console.log(msg)
            renderOrderBook(msg.data)
        })

    })
</script>
{% endblock %}

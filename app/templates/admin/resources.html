{% extends "admin/layout.html" %}

{% block content %}
<div class="card border-0 shadow-sm mb-3">
    <div class="card-body">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
            <div class="d-flex align-items-center gap-2 flex-grow-1" style="max-width: 600px;">
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
                    <input type="text" id="globalSearch" class="form-control border-start-0"
                           placeholder="æœç´¢èµ„æºåç§°ã€é…æ–¹æˆ– ID...">
                </div>
                <select class="form-select w-auto" id="filterCategory">
                    <option value="all">æ‰€æœ‰åˆ†ç±»</option>
                    <option value="raw">åŸå§‹ææ–™</option>
                    <option value="intermediate">ä¸­é—´ä½“</option>
                    <option value="final">æœ€ç»ˆäº§å“</option>
                </select>
                <select class="form-select w-auto" id="filterBuilding">
                    <option value="all">æ‰€æœ‰å»ºç­‘</option>
                </select>
            </div>

            <div class="d-flex align-items-center gap-3">
                <div class="btn-group shadow-sm" role="group" aria-label="è§†å›¾åˆ‡æ¢">
                    <input type="radio" class="btn-check" name="viewMode" id="viewModeGraph" autocomplete="off" checked
                           onchange="switchView('graph')">
                    <label class="btn btn-outline-primary" for="viewModeGraph" title="å›¾å½¢å…³ç³»è§†å›¾">
                        <i class="bi bi-diagram-3-fill"></i>
                    </label>

                    <input type="radio" class="btn-check" name="viewMode" id="viewModeTable" autocomplete="off"
                           onchange="switchView('table')">
                    <label class="btn btn-outline-primary" for="viewModeTable" title="æ•°æ®åˆ—è¡¨è§†å›¾">
                        <i class="bi bi-table"></i>
                    </label>
                </div>

                <div class="vr mx-1"></div>
                <div class="d-flex gap-2">
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addResourceModal">
                        <i class="bi bi-plus-circle"></i> æ–°å¢èµ„æº
                    </button>
                    <button class="btn btn-outline-secondary" id="btnResetLayout" onclick="resetLayout()">
                        <i class="bi bi-arrows-move"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="view-container-table" class="view-panel ">
    <div class="card shadow-sm border-0">
        <div class="table-responsive" style="height: 750px;">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light sticky-top" style="z-index: 10;">
                <tr>
                    <th class="ps-4">äº§å‡ºèµ„æº / é…æ–¹åç§°</th>
                    <th>æ‰€å±å»ºç­‘</th>
                    <th style="min-width: 250px;">æ‰€éœ€ææ–™ (æ•°é‡/å“è´¨)</th>
                    <th>æ¯å°æ—¶äº§å‡º</th>
                    <th class="text-end pe-4">æ“ä½œ</th>
                </tr>
                </thead>
                <tbody id="recipeTableBody">
                </tbody>
            </table>
        </div>
    </div>
</div>
<div class="modal fade" id="addResourceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-box-seam me-2"></i>å®šä¹‰æ–°èµ„æº</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="addResourceForm" onsubmit="handleCreateResource(event)">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label small fw-bold">èµ„æºåç§° <span class="text-danger">*</span></label>
                        <input type="text" name="name" class="form-control" placeholder="ä¾‹å¦‚ï¼šç²¾åˆ¶é¢ç²‰" required>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">åŸºç¡€ä»·æ ¼ (åˆ†)</label>
                            <div class="input-group">
                                <span class="input-group-text">Â¥</span>
                                <input type="number" name="base_price" class="form-control" value="0">
                            </div>
                            <div class="form-text">å•ä½ä¸ºæœ€å°è´§å¸å•ä½</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">èµ„æºåˆ†ç±»</label>
                            <select name="industry_id" class="form-select" id="resCategory">

                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label small fw-bold">å›¾è°±æ ‡è¯†</label>
                            <div class="d-flex gap-3 align-items-center bg-light p-3 rounded">
                                <div id="iconPreview"
                                     class="bg-white rounded border d-flex align-items-center justify-content-center"
                                     style="width: 50px; height: 50px;">
                                    <i class="bi bi-question-lg fs-3 text-muted"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <select class="form-select form-select-sm mb-2" name="icon"
                                            onchange="updateIconPreview(this.value)">
                                        <option value="box-seam">ğŸ“¦ é»˜è®¤æ–¹ç®±</option>
                                        <option value="droplet">ğŸ’§ æ¶²ä½“/æ°´</option>
                                        <option value="lightning">âš¡ èƒ½æº/ç”µåŠ›</option>
                                        <option value="gem">ğŸ’ çŸ¿çŸ³/ç¨€æœ‰</option>
                                        <option value="egg-fried">ğŸ³ é£Ÿç‰©/çƒ¹é¥ª</option>
                                        <option value="gear">âš™ï¸ é›¶ä»¶/æœºæ¢°</option>
                                    </select>
                                    <input type="color" name="color"
                                           class="form-control form-control-color form-control-sm w-100" value="#0d6efd"
                                           title="åœ¨å›¾è°±ä¸­æ˜¾ç¤ºçš„èŠ‚ç‚¹é¢œè‰²">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-0">
                        <label class="form-label small fw-bold">æè¿°/å†…éƒ¨å¤‡æ³¨</label>
                        <textarea name="description" class="form-control" rows="2"
                                  placeholder="ä»…ä¾›åå°æŸ¥çœ‹..."></textarea>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary px-4">ç¡®è®¤åˆ›å»º</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% include 'admin/editRecipeModal.html' %}
{% endblock %}

{% block scripts %}
<!--ä»æœ¬åœ° gameData æ¸²æŸ“é…æ–¹ç®¡ç†è¡¨æ ¼ -->
<script>
    async function renderRecipeTable() {
        const tbody = document.getElementById('recipeTableBody');
        // 1. å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿æ•°æ®å·²åŠ è½½
        await window.gameDataPromise
        const {recipes, buildings, resources} = window.gameData;
        let html = '';

        resources.forEach(res => {
                const recipe = recipes.find(r => r.output_resource_id === res.id)
                const building = recipe ? buildings.find(b => b.id === recipe.building_meta_id) : {name: 'æœªçŸ¥å»ºç­‘'};
                // 3. å¤„ç†åŸææ–™ (Inputs) çš„æ˜¾ç¤º
                let inputsHtml = '';
                if (recipe && recipe.inputs && recipe.inputs.length > 0) {
                    inputsHtml = recipe.inputs.map(input => {
                        // æ ¹æ® input.resource_id æ‰¾åˆ°å¯¹åº”çš„èµ„æºè¯¦æƒ…
                        const resDetail = resources.find(r => r.id === input.resource_id) || {name: 'æœªçŸ¥', icon: '?'};
                        return `
                            <div class="d-inline-flex align-items-center bg-light border rounded px-2 py-1 me-1 mb-1">
                                <span class="me-1">ğŸ˜‚</span>
                                <span class="small fw-bold">${resDetail.name}</span>
                                <span class="badge bg-primary ms-2">x${input.quantity}</span>
                                ${input.quality_req > 1 ? `<span class="badge bg-warning text-dark ms-1">Q${input.quality_req}</span>` : ''}
                            </div>`;
                    }).join('');
                } else {
                    inputsHtml = '<span class="text-muted small">æ— éœ€åŸææ–™</span>';
                }

                // 4. æ„é€ è¡Œ HTML
                html += `
                    <tr>
                        <td class="ps-4">
                            <div class="d-flex align-items-center">
                                <div>
                                    <div class="fw-bold text-dark">${res.name}</div>
                                    <small class="text-muted">ID: ${res.id} | äº§å‡º: 1</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-info-subtle text-info border border-info-subtle px-2 py-1">
                                <i class="bi bi-house-door me-1"></i>${building.name}
                            </span>
                        </td>
                        <td>
                            <div class="d-flex flex-wrap">${inputsHtml}</div>
                        </td>
                        <td>
                            <div class="fw-bold">${recipe ? recipe.per_hour : 0} </div>
                        </td>
                        <td class="text-end pe-4">
                            <div class="btn-group shadow-sm">
                                <button class="btn btn-sm btn-white border" data-bs-target="#editRecipeModal" data-bs-toggle="modal"
                                    data-bs-id = "${res.id}"
                                    title="ä¿®æ”¹">
                                    <i class="bi bi-pencil text-primary"></i>
                                </button>
                            </div>
                        </td>
                    </tr>`;
            }
        )
        tbody.innerHTML = html || '<tr><td colspan="6" class="text-center py-4">æœ¬åœ°åº“ä¸­æš‚æ— é…æ–¹</td></tr>';


    }

    renderRecipeTable();
</script>
<!-- èµ„æºæ·»åŠ modal -->
<script>
    document.getElementById('addResourceModal').addEventListener('show.bs.modal', function () {
        const ele = document.querySelector("#resCategory")
        ele.innerHTML = ""
        for (const c of window.gameData.industries) {
            ele.innerHTML += `<option value="${c.id}">${renderIcon(c.icon)} ${c.name}</option>`
        }
    })

    // å®æ—¶æ›´æ–°æ¨¡æ€æ¡†ä¸­çš„å›¾æ ‡é¢„è§ˆ
    function updateIconPreview(iconName) {
        const preview = document.getElementById('iconPreview');
        preview.innerHTML = `<i class="bi bi-${iconName} fs-3 text-primary"></i>`;
    }

    // æäº¤åˆ›å»ºèµ„æº
    async function handleCreateResource(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const payload = Object.fromEntries(formData.entries());

        // æ ¼å¼åŒ–æ•°æ®ä»¥ç¬¦åˆåç«¯è¦æ±‚
        payload.base_price = parseFloat(payload.base_price);

        try {
            const response = await fetch('/api/admin/resources/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                showToast("èµ„æºåˆ›å»ºæˆåŠŸï¼", 'success');
                bootstrap.Modal.getInstance(document.getElementById('addResourceModal')).hide();

                // é‡è¦ï¼šåˆ·æ–°å›¾è°±
                if (typeof loadResourceGraph === 'function') loadResourceGraph();
                form.reset();
            } else {
                const err = await response.json();
                showToast("åˆ›å»ºå¤±è´¥: " + (err.detail || "æ ¡éªŒæœªé€šè¿‡"), 'error');
            }
        } catch (error) {
            showToast("æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨", 'error');
        }
    }

</script>

{% endblock %}
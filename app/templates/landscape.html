{% extends "layout.html" %}

{% block content %}
<style>
    /* 游戏大盘网格 */
    .game-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        grid-template-rows: repeat(4, 1fr);
        gap: 15px;
        padding: 15px;

    }


    /* 单个地块样式 */
    .plot-card {
        /*aspect-ratio: 1 / 1;*/
        background: #ffffff;
        border: 4px solid #bdc3c7;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    .landscape-container {
        flex-grow: 1;
        position: relative;
        height: calc(100vh - 60px); /* 视口高度减去顶部导航栏 */
        overflow: hidden;
    }

    .plot-card:hover {
        transform: translateY(-5px) scale(1.02);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        z-index: 10;
    }

    /* 不同建筑的状态颜色 */
    .plot-active {
        border-color: #2ecc71;
        background: #f0fff4;
    }

    .plot-idle {
        border-color: #f1c40f;
        background: #fffdf0;
    }

    .plot-empty {
        border-color: #ecf0f1;
        border-style: dashed;
        background: #f9f9f9;
        opacity: 0.8;
    }

    /* 浮动状态标贴 */
    .plot-status-badge {
        position: absolute;
        top: 8px;
        right: 8px;
        font-size: 0.7rem;
    }

    .building-icon {
        font-size: 3rem;
        margin-bottom: 5px;
    }

    .building-name {
        font-weight: bold;
        font-size: 0.9rem;
        color: #2c3e50;
    }

    /* 生产进度遮罩 */
    .plot-progress {
        position: absolute;
        bottom: 0;
        left: 0;
        height: 6px;
        background: #2ecc71;
        transition: width 0.5s;
    }
</style>

<div class="game-grid h-100  flex-grow-1 " id="building-container">
    {% for i in range(16) %}
    <div class="plot-card plot-empty">
        <div class="h1 text-muted">+</div>
        <div class="small">空地</div>
    </div>
    {% endfor %}
</div>
{% include 'components/buildingControlModal.html' %}
{% include 'components/buildingDetailModal.html' %}

<script>
<!-- 界面变量 -->
let playerBuildingInstances = null;

</script>
<script>

    async function loadBuildings() {
        const container = document.getElementById('building-container');
        try {
            // 1. 调用你的异步 API
            const response = await fetch('/api/buildings');
            playerBuildingInstances = await response.json(); // 假设返回 { buildings: [...] }
            const totalSlots = 16;

            // 清空容器（移除占位符）
            container.innerHTML = '';

            for (let i = 0; i < totalSlots; i++) {
                const building = playerBuildingInstances.find(b => b.slot_number === i); // 假设 API 返回的是带索引的数组或你可以按需分配

                const card = document.createElement('div');

                if (building) {
                    // 有建筑的情况
                    card.className = `plot-card ${building.task ? 'plot-active' : 'plot-idle'}`;
                    card.setAttribute('data-bs-toggle', 'modal');
                    card.setAttribute('data-bs-target', '#buildingDetailModal');
                    card.setAttribute('data-id', building.id)
                    card.setAttribute('data-slot-num', i)
                    const now = Date.now() ;
                    if (building.task) {
                        const end_time = new Date(building.task.end_time).getTime();
                        card.innerHTML += `
                        <span class="plot-status-badge badge rounded-pill
                            ${(now >= building.task.end_time ? 'bg-success' : 'bg-primary')}">

                            ${(now >= end_time ? '可领取' : '生产中')}
                        </span>`
                    } else {
                        card.innerHTML += `<span class="plot-status-badge badge rounded-pill bg-warning text-dark
                            闲置
                        </span>`
                    }
                    card.innerHTML += `
                    <div class="building-icon">${renderIcon(building.building_meta.icon)}</div>
                    <div class="building-name fw-bold small">${building.building_meta.name}</div>
                    <div class="text-muted" style="font-size: 0.7rem;">Lv.${building.level}</div>
                    ${building.task ? `<div class="plot-progress"
                    style="width:${calculateProgress(building.task.start_time, building.task.end_time)}%"></div>` : ''}
                    `;
                } else {
// 真正意义上的空地
                    card.className = 'plot-card plot-empty';

                    // 1. 确保 data-bs-toggle="modal" 拼写正确
                    // 2. 确保 data-bs-target 的值与你 modal 文件里的 id 属性一致
                    card.setAttribute('data-bs-toggle', 'modal');
                    card.setAttribute('data-bs-target', '#buildingControlModal'); // 假设你 modal 的 ID 是这个
                    card.setAttribute("data-slot-num", i)

                    card.innerHTML = `
                        <div class="h3 text-muted opacity-50">+</div>
                        <div class="small text-muted">空地</div>
                    `;
                }
                container.appendChild(card);

            }

        } catch
            (error) {
            console.error("加载基地失败:", error);
            container.innerHTML = '<div class="alert alert-danger w-100 m-2">连接基地失败，请刷新重试</div>';
        }
    }

    // 页面加载时执行
    document.addEventListener('DOMContentLoaded', async () => {
        await loadBuildings()
    });
</script>
{% endblock %}
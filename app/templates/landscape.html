{% extends "layout.html" %}

{% block content %}
<style>
    /* æ¸¸æˆå¤§ç›˜ç½‘æ ¼ */
    .game-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        grid-template-rows: repeat(4, 1fr);
        gap: 15px;
        padding: 15px;
        /* æ ¸å¿ƒç‚¹ï¼šé«˜åº¦è®¡ç®—å‡å»é¡¶éƒ¨ Navbar å³å¯ */
        height: calc(100vh - 60px);
        width: 100%;
    }

    /* å•ä¸ªåœ°å—æ ·å¼ */
    .plot-card {
        /*aspect-ratio: 1 / 1;*/
        background: #ffffff;
        border: 4px solid #bdc3c7;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    .landscape-container {
        flex-grow: 1;
        position: relative;
        height: calc(100vh - 60px); /* è§†å£é«˜åº¦å‡å»é¡¶éƒ¨å¯¼èˆªæ  */
        overflow: hidden;
    }

    .plot-card:hover {
        transform: translateY(-5px) scale(1.02);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        z-index: 10;
    }

    /* ä¸åŒå»ºç­‘çš„çŠ¶æ€é¢œè‰² */
    .plot-active {
        border-color: #2ecc71;
        background: #f0fff4;
    }

    .plot-idle {
        border-color: #f1c40f;
        background: #fffdf0;
    }

    .plot-empty {
        border-color: #ecf0f1;
        border-style: dashed;
        background: #f9f9f9;
        opacity: 0.8;
    }

    /* æµ®åŠ¨çŠ¶æ€æ ‡è´´ */
    .plot-status-badge {
        position: absolute;
        top: 8px;
        right: 8px;
        font-size: 0.7rem;
    }

    .building-icon {
        font-size: 3rem;
        margin-bottom: 5px;
    }

    .building-name {
        font-weight: bold;
        font-size: 0.9rem;
        color: #2c3e50;
    }

    /* ç”Ÿäº§è¿›åº¦é®ç½© */
    .plot-progress {
        position: absolute;
        bottom: 0;
        left: 0;
        height: 6px;
        background: #2ecc71;
        transition: width 0.5s;
    }
</style>

<div class="game-grid" id="building-container">
    {% for i in range(16) %}
    <div class="plot-card plot-empty">
        <div class="h1 text-muted">+</div>
        <div class="small">ç©ºåœ°</div>
    </div>
    {% endfor %}
</div>
<div class="modal fade" id="buildingControlModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold text-dark">
                    <i class="bi bi-tools me-2"></i>æ–°å»ºå»ºç­‘é¡¹ç›®
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body p-4">
                <div class="mb-4">
                    <label class="form-label small fw-bold text-muted text-uppercase">é€‰æ‹©è®¾æ–½</label>
                    <select class="form-select form-select-lg border-2" id="select-building"
                            onclick="handleSelectChange(this.value)"
                    >

                    </select>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-6">
                        <div class="p-3 border rounded bg-light text-center">
                            <small class="text-muted d-block mb-1">é¢„è®¡å·¥æœŸ</small>
                            <h4 class="mb-0 fw-bold text-primary" id="m-time">2h</h4>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-3 border rounded bg-light text-center">
                            <small class="text-muted d-block mb-1">æ–½å·¥æ¬¾é¡¹</small>
                            <h4 class="mb-0 fw-bold text-success" id="m-cash">$</h4>
                        </div>
                    </div>
                </div>

                <div class="mb-2">
                    <label class="form-label small fw-bold text-muted text-uppercase">æ‰€éœ€å»ºç­‘ææ–™</label>
                    <div class="list-group shadow-sm">
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-box me-2"></i>é’¢æ (Steel)</span>
                            <div class="text-end">
                                <span class="fw-bold" id="req-steel">100</span>
                                <small class="text-muted">/ 120 (åº“å­˜)</small>
                                <i class="bi bi-check-circle-fill text-success ms-2"></i>
                            </div>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-layers me-2"></i>æ··å‡åœŸ (Concrete)</span>
                            <div class="text-end">
                                <span class="fw-bold text-danger" id="req-concrete">50</span>
                                <small class="text-muted">/ 12 (åº“å­˜)</small>
                                <i class="bi bi-x-circle-fill text-danger ms-2"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <p class="small text-danger mt-3 mb-0" id="m-warning">
                    <i class="bi bi-exclamation-triangle me-1"></i> ææ–™ä¸è¶³ï¼Œæ— æ³•å¼€å§‹æ–½å·¥ã€‚
                </p>
            </div>

            <div class="modal-footer border-0 p-3 bg-light">
                <button type="button" id="btn-build" class="btn btn-primary px-5 fw-bold shadow-sm"
                        data-bs-dismiss="modal">
                    ç¡®è®¤æ–½å·¥
                </button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="buildingDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg bg-light">
            <div class="modal-header bg-dark text-white p-3">
                <h5 class="modal-title fw-bold">
                    <i class="bi bi-factory me-2"></i>
                    <span id="det-name">é«˜çº§ç‚¼é’¢å‚</span>
                    <span class="badge bg-primary ms-2">Lv.<span id="det-level">3</span></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body p-0">
                <div class="row g-0">
                    <div class="col-lg-3 border-end p-4">
                        <section class="mb-4">
                            <h6 class="text-muted small fw-bold text-uppercase mb-3">å»ºç­‘è¯¦æƒ…</h6>
                            <div class="d-flex align-items-center mb-3">
                                <div class="fs-1 me-3" id="det-icon">ğŸ—ï¸</div>
                                <div>
                                    <div class="fw-bold">ç»´æŠ¤æˆæœ¬</div>
                                    <div class="text-danger">-$450/hr</div>
                                </div>
                            </div>
                            <div class="small text-muted">è¿è¡Œæ•ˆç‡: <span class="text-dark fw-bold">98%</span></div>
                        </section>

                        <hr>

                        <section class="mb-4">
                            <h6 class="text-muted small fw-bold text-uppercase mb-3">å»ºç­‘æ“ä½œ</h6>
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary btn-sm fw-bold" id="upgrade-building-btn">å‡çº§å»ºç­‘
                                </button>
                                <button class="btn btn-outline-secondary btn-sm">æ¬è¿åœ°å—</button>
                                <button class="btn btn-outline-danger btn-sm">æŠ¥åºŸæ‹†é™¤</button>
                            </div>
                        </section>
                    </div>
                    <div class="col-lg-9 p-4 bg-white">
                        <h6 class="text-muted small fw-bold text-uppercase mb-3">æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡</h6>
                        <div class="d-flex align-items-center mb-3" id="building-task-container">
                            <span class="text-muted small">å½“å‰æ— è¿›è¡Œä¸­ä»»åŠ¡</span>
                        </div>
                        <h6 class="text-muted small fw-bold text-uppercase mb-3">å¯ç”Ÿäº§èµ„æºåˆ—è¡¨</h6>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle border">
                                <thead class="table-light">
                                <tr>
                                    <th>äº§å‡ºèµ„æº</th>
                                    <th>åŸæ–™</th>
                                    <th>äº§å‡º</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                                </thead>
                                <tbody id="production-list-container">
                                <tr>
                                    <td colspan="4" class="text-center py-5 text-muted">
                                        <div class="spinner-border spinner-border-sm me-2"></div>
                                        æ­£åœ¨åŠ è½½ç”Ÿäº§æ–¹æ¡ˆ...
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% block scripts %}

<script>
    const modalElem = document.getElementById('buildingDetailModal');
    document.querySelector("#upgrade-building-btn").addEventListener("click", async function () {
        const buildingId = this.getAttribute("data-id");
        if (!buildingId) return;

        console.log("æ‰§è¡Œå‡çº§ï¼Œå»ºç­‘ ID:", buildingId);
        await upgradeBuilding(buildingId);
    });

    async function upgradeBuilding(buildingId) {
        // å‡çº§
        const response = await fetch(`/api/buildings/upgrade/${buildingId}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
        });
        if (response.ok) {
            alert("å‡çº§æˆåŠŸï¼");

        } else {
            const err = await response.json();
            alert("å‡çº§å¤±è´¥: " + err.detail);
        }
    }

    // å®šä¹‰å…·åå‡½æ•°ä»¥ä¾¿ç§»é™¤
    async function onModalShow(event) {
        console.log("joojp")
        // 1. è·å–ç‚¹å‡»çš„æŒ‰é’®
        const button = event.relatedTarget;
        // 2. æå– data-id (è¿™å°±æ˜¯å»ºç­‘å®ä¾‹ ID)
        const player_building_id = parseInt(button.getAttribute('data-id'));

        document.querySelector("#upgrade-building-btn").setAttribute("data-id", player_building_id)

        // 3. ä»å…¨å±€æ•°æ®ä¸­æŸ¥æ‰¾è¯¥å®ä¾‹å’Œå®ƒçš„å…ƒæ•°æ®
        const res = await fetch("/api/buildings/");
        const data = await res.json(); // å†æ¬¡ await ä»¥è§£ææ•°æ®
        const instance = data.find(pb => pb.id === player_building_id);
        console.log(instance)
        // æ‰¾åˆ°è¯¥å®ä¾‹å¯¹åº”çš„å»ºç­‘ç±»å‹å…ƒæ•°æ®
        const building_meta = window.gameData.buildings.find(b => b.id === instance.building_meta_id);
        if (!building_meta) return;

        // --- å¡«å……å·¦ä¾§ï¼šå»ºç­‘è¯¦æƒ… ---
        document.getElementById('det-name').textContent = building_meta.name;
        document.getElementById('det-level').textContent = instance.level || 99;
        document.getElementById('det-icon').innerHTML = `<i class="${building_meta.icon} me-2"></i>` || 'ğŸ—ï¸';

        // è®¡ç®—ç»´æŠ¤æˆæœ¬ (å‡è®¾æ¯çº§å¢åŠ  50%)
        const maintenanceSection = document.querySelector('#det-icon').nextElementSibling;
        maintenanceSection.innerHTML = `
        <div class="fw-bold">ä½¿ç”¨æˆæœ¬ /å°æ—¶</div>
        <div class="text-danger">-$${building_meta.maintenance_cost || 0}/hr</div>
    `;
        // è¿›è¡Œä¸­çš„ä»»åŠ¡åˆ—è¡¨
        await refreshTaskDisplay(player_building_id);
        // --- å¡«å……å³ä¾§ï¼šç”Ÿäº§åˆ—è¡¨ ---
        renderProductionList(building_meta.id, player_building_id);
    }

    modalElem.removeEventListener('show.bs.modal', onModalShow);
    modalElem.addEventListener('show.bs.modal', onModalShow);

    //
    async function refreshTaskDisplay(playerBuildingId) {
        try {
            // æ‰¾åˆ°ä½ åˆšæ‰å®šä¹‰çš„å®¹å™¨ (å‡è®¾ ID ä¸º task-container)
            const container = document.querySelector('#building-task-container');
            // 1. ä»ä½ çš„ FastAPI CRUD æ¥å£è¯·æ±‚æ•°æ®
            const response = await fetch(`/api/task/${playerBuildingId}`);
            if (response.status != 200) {
                container.innerHTML = '<span class="text-muted small">å½“å‰æ— è¿›è¡Œä¸­ä»»åŠ¡</span>';
                return;
            }
            const task = await response.json();

            if (!task) {
                container.innerHTML = '<span class="text-muted small">å½“å‰æ— è¿›è¡Œä¸­ä»»åŠ¡</span>';
                return;
            }

            // 3. æ•°å­¦è®¡ç®—ï¼šè¿›åº¦ç™¾åˆ†æ¯”
            const now = new Date().getTime();
            const start = new Date(task.start_time).getTime();
            const end = new Date(task.end_time).getTime();
            const total = end - start;
            const elapsed = now - start;
            const progress = Math.min(100, Math.max(0, (elapsed / total) * 100));

            // è®¡ç®—å‰©ä½™ç§’æ•°
            const remainingSec = Math.max(0, Math.floor((end - now) / 1000));

            // 4. å¡«å…… HTML (ä½¿ç”¨ä½ åˆšæ‰é‚£ä¸€è¡Œçš„ç»“æ„)
            const resource = window.gameData.resources.find(r => r.id == task.resource_id)
            container.innerHTML = `
            <div class="flex-grow-1">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="fw-bold small">
                         ${renderIcon(resource.icon)}
                         ${resource.name}
                         <span>${task.task_type === 'upgrade' ? 'å»ºç­‘å‡çº§' : 'ç”Ÿäº§ä¸­'}</span>
                    </span>
                    <span class="badge rounded-pill bg-light text-primary border small">
                        ${remainingSec > 0 ? formatTime(remainingSec) : 'âœ… å·²å®Œæˆ'}
                    </span>
                </div>
                <div class="progress" style="height: 6px;">
                    <div class="progress-bar progress-bar-striped ${remainingSec > 0 ? 'progress-bar-animated' : ''} bg-success"
                         role="progressbar"
                         style="width: ${progress}%"></div>
                </div>
                <div class="d-flex justify-content-between mt-1" style="font-size: 0.75rem;">
                    <span class="text-muted">äº§å‡º: <strong class="text-dark">+${task.quantity}</strong></span>
                    <span class="text-muted">è¿›åº¦: <span>${Math.floor(progress)}</span>%</span>
                </div>
            </div>
        `;

            // 5. å¦‚æœä»»åŠ¡åˆšå®Œæˆï¼Œå¯ä»¥è§¦å‘ä¸€æ¬¡è‡ªåŠ¨ç»“ç®—ï¼ˆæˆ–è€…æ˜¾ç¤ºé¢†å–æŒ‰é’®ï¼‰
            if (remainingSec === 0) {
                console.log("æ£€æµ‹åˆ°ä»»åŠ¡å®Œæˆï¼Œç­‰å¾…ç©å®¶é¢†å–...");
            }

        } catch (error) {
            console.error("æ— æ³•è·å–ä»»åŠ¡çŠ¶æ€:", error);
        }
    }

    /**
     * æ¸²æŸ“ç”Ÿäº§åˆ—è¡¨ (é…åˆ gameData)
     */
    function renderProductionList(buildingMetaId, playerBuildingId) {
        const container = document.getElementById('production-list-container');
        const recipes = window.gameData.recipes.filter(r => r.building_meta_id === buildingMetaId);

        if (!recipes || recipes.length === 0) {
            container.innerHTML = '<tr><td colspan="4" class="text-center py-5 text-muted">æ­¤å»ºç­‘ç›®å‰æ— å¯ç”Ÿäº§æ–¹æ¡ˆ</td></tr>';
            return;
        }

        container.innerHTML = recipes.map(recipe => {
            const outputRes = window.gameData.resources.find(r => r.id === recipe.output.id);
            const perHr = recipe.per_hour; // æ¯å°æ—¶äº§å‡ºåŸºæ•°

            return `
            <tr class="align-middle" data-recipe-id="${recipe.id}">
                <td class="py-3" style="width: 25%;">
                    <div class="d-flex align-items-center">
                        <div class="bg-primary bg-opacity-10 p-2 rounded me-3">
                            <span class="fs-4">${renderIcon(outputRes.icon)}</span>
                        </div>
                        <div>
                            <div class="fw-bold text-dark">${outputRes.name}</div>
                            <div class="text-muted" style="font-size: 0.7rem;">
                                ç”Ÿäº§é€Ÿç‡: ${recipe.per_hour} / å°æ—¶
                            </div>
                        </div>
                    </div>
                </td>

                <td style="width: 30%;">
                    <div id="recipe-materials-${recipe.id}" class="d-flex flex-column gap-1">
                        </div>
                </td>

                <td style="width: 25%;">
                    <div class="px-2">
                        <div class="input-group input-group-sm mb-2 shadow-sm">
                            <span class="input-group-text bg-light">æ—¶é•¿</span>
                            <input type="number" class="form-control text-center fw-bold"
                                   id="hr-input-${recipe.id}"
                                   oninput="updatePreview(${recipe.id})"
                                   value="0"
                                   max="72">
                            <span class="input-group-text bg-light">å°æ—¶</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center bg-light rounded px-2 py-1">
                            <small class="text-muted">é¢„è®¡æ€»äº§å‡º:</small>
                            <strong class="text-primary fs-5" id="preview-qty-${recipe.id}">0</strong>
                        </div>
                    </div>
                </td>

                <td style="width: 20%;" class="text-end">
                    <button class="btn btn-primary w-100 shadow-sm fw-bold py-2"
                            id="btn-start-${recipe.id}"
                            onclick="executeStartProduction(${recipe.id}, ${playerBuildingId})"
                            data-bs-dismiss="modal"
                            >
                        å¼€å§‹ç”Ÿäº§
                    </button>
                </td>
            </tr>`;
        }).join('');

        // åˆå§‹æ‰§è¡Œä¸€æ¬¡é¢„è§ˆæ›´æ–°ï¼Œå¡«å……ææ–™å’Œæ•°é‡
        recipes.forEach(r => updatePreview(r.id));
    }

    async function updatePreview(recipeId) {
        const recipe = window.gameData.recipes.find(r => r.id === recipeId);
        const hours = parseFloat(document.getElementById(`hr-input-${recipeId}`).value) || 0;

        // 1. è®¡ç®—äº§å‡º
        const perHr = recipe.per_hour;
        const totalOutput = Math.floor(perHr * hours);
        document.getElementById(`preview-qty-${recipeId}`).innerText = totalOutput.toLocaleString();

        // 2. è®¡ç®—å¹¶æ¸²æŸ“ææ–™éœ€æ±‚
        const materialContainer = document.getElementById(`recipe-materials-${recipeId}`);
        const startBtn = document.getElementById(`btn-start-${recipeId}`);
        let canAfford = true;
        const resp = await fetch(`/api/inventory/`);
        const playerInventory = await resp.json()

        materialContainer.innerHTML = recipe.inputs.map((input) => {
            const res = window.gameData.resources.find(r => r.id === input.resource_id);
            const totalNeeded = Math.ceil(perHr * hours * input.quantity);
            const item = playerInventory.find(r => r.resource_id === input.resource_id)
            const currentStock = item ? item['quantity'] : 0
            const isShortage = currentStock < totalNeeded;
            console.log(currentStock, totalNeeded)

            if (isShortage) canAfford = false;

            return `
            <div class="d-flex justify-content-between align-items-center p-1 rounded ${isShortage ? 'bg-danger bg-opacity-10' : 'bg-light'}"
                 style="font-size: 0.85rem;">
                <span class="${isShortage ? 'text-danger fw-bold' : 'text-dark'}">
                    ${renderIcon(res.icon)} ${res.name}
                </span>
                <span class="small">
                    <span class="${isShortage ? 'text-danger fw-bold' : 'text-muted'}">${totalNeeded}</span>
                    <span class="text-secondary">/ åº“å­˜:${currentStock}</span>
                </span>
            </div>
        `;
        }).join('');

        // 3. è‡ªåŠ¨ç¦ç”¨æŒ‰é’®ï¼ˆå¦‚æœåº“å­˜ä¸è¶³ï¼‰
        if (!canAfford) {
            startBtn.classList.add('disabled');
            startBtn.innerText = 'åº“å­˜ä¸è¶³';
        } else {
            startBtn.classList.remove('disabled');
            startBtn.innerText = 'å¼€å§‹ç”Ÿäº§';
        }
    }

    /**
     * è§¦å‘å»ºç­‘ç”Ÿäº§ä»»åŠ¡
     * @param
     */
    async function executeStartProduction(recipeId, playerBuildingId) {
        const recipe = window.gameData.recipes.find(recipe => recipe.id === recipeId);

        // 1. æ„é€ ç¬¦åˆ BuildingTaskCreate Schema çš„æ•°æ®
        const now = new Date();
        const hours = parseFloat(document.querySelector(`#hr-input-${recipe.id}`).value);

        const quantity = parseInt(hours * recipe.per_hour)

        const taskData = {
            player_building_id: playerBuildingId,
            resource_id: recipe.output.id,
            quantity: quantity,
            start_time: now.toISOString(),
        };

        try {
            // 2. å‘é€è¯·æ±‚åˆ° FastAPI æ¥å£
            const response = await fetch('/api/task/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(taskData)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'ç”Ÿäº§å¯åŠ¨å¤±è´¥');
            }
        } catch (error) {
            console.error("ç”Ÿäº§é”™è¯¯:", error);
        }
    }
</script>
<script>
    function handleSelectChange(val) {
        const building_meta_id = val;
        document.querySelector("#m-cash").innerText = `$ ${window.gameData.buildings.find(b => b.id == building_meta_id).building_cost}`
    }

    function renderSelectBuilding() {
        const buildings = window.gameData.buildings;
        const ele = document.querySelector("#select-building")
        ele.innerHTML = ""
        for (const building of buildings) {
            ele.innerHTML += `<option value="${building.id}">${renderIcon(building.icon)} ${building.name}</option>`
        }
    }

    document.getElementById('btn-build').addEventListener('click', async function () {
        const select = document.getElementById('select-building');
        const selectedOption = select.options[select.selectedIndex];
        // è·å–ç»‘å®šçš„ ID
        const buildingId = selectedOption.getAttribute('value');
        const buildingName = selectedOption.text;
        console.log(buildingId);

        // å‘é€ç»™åç«¯
        fetch('/api/buildings/construct', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                building_meta_id: buildingId // è¿™é‡Œçš„ ID å¾ˆå…³é”®
            })
        }).then(res => {
            if (res.ok) alert(`${buildingName} å¼€å§‹æ–½å·¥ï¼`);
        }).catch(e => {
            showToast(e.toLocaleString())
        })
        await loadBuildings()
        ;
    });

    document.addEventListener("gameInitDone", () => {
        renderSelectBuilding()
    })
</script>


{% endblock %}

<script>

    async function loadBuildings() {
        const container = document.getElementById('building-container');
        try {
            // 1. è°ƒç”¨ä½ çš„å¼‚æ­¥ API
            const response = await fetch('/api/buildings');
            const data = await response.json(); // å‡è®¾è¿”å› { buildings: [...] }
            const buildings = data || [];
            const totalSlots = 16;

            // æ¸…ç©ºå®¹å™¨ï¼ˆç§»é™¤å ä½ç¬¦ï¼‰
            container.innerHTML = '';

            for (let i = 0; i < totalSlots; i++) {
                const building = buildings[i]; // å‡è®¾ API è¿”å›çš„æ˜¯å¸¦ç´¢å¼•çš„æ•°ç»„æˆ–ä½ å¯ä»¥æŒ‰éœ€åˆ†é…
                const card = document.createElement('div');

                if (building) {
                    // æœ‰å»ºç­‘çš„æƒ…å†µ
                    card.className = `plot-card ${building.is_producing ? 'plot-active' : 'plot-idle'}`;
                    card.setAttribute('data-bs-toggle', 'modal');
                    card.setAttribute('data-bs-target', '#buildingDetailModal');
                    card.setAttribute('data-id', building.id)
                    card.innerHTML = `
                    <span class="plot-status-badge badge rounded-pill ${building.task ? 'bg-success' : 'bg-warning text-dark'}">
                        ${building.task ? 'ç”Ÿäº§ä¸­' : 'é—²ç½®'}
                    </span>
                    <div class="building-icon">${renderIcon(building.building_meta.icon)}</div>
                    <div class="building-name fw-bold small">${building.building_meta.name}</div>
                    <div class="text-muted" style="font-size: 0.7rem;">Lv.${building.level}</div>
                    ${building.task ? `<div class="plot-progress"
                    style="width:${calculateProgress(building.task.start_time, building.task.end_time)}%"></div>` : ''}
                    `;
                } else {
// çœŸæ­£æ„ä¹‰ä¸Šçš„ç©ºåœ°
                    card.className = 'plot-card plot-empty';

                    // 1. ç¡®ä¿ data-bs-toggle="modal" æ‹¼å†™æ­£ç¡®
                    // 2. ç¡®ä¿ data-bs-target çš„å€¼ä¸ä½  modal æ–‡ä»¶é‡Œçš„ id å±æ€§ä¸€è‡´
                    card.setAttribute('data-bs-toggle', 'modal');
                    card.setAttribute('data-bs-target', '#buildingControlModal'); // å‡è®¾ä½  modal çš„ ID æ˜¯è¿™ä¸ª

                    card.innerHTML = `
                        <div class="h3 text-muted opacity-50">+</div>
                        <div class="small text-muted">ç©ºåœ°</div>
                    `;
                }
                container.appendChild(card);

            }

        } catch
            (error) {
            console.error("åŠ è½½åŸºåœ°å¤±è´¥:", error);
            container.innerHTML = '<div class="alert alert-danger w-100 m-2">è¿æ¥åŸºåœ°å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
        }
    }

    // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', async () => {
        await loadBuildings()
    });
</script>
{% endblock %}
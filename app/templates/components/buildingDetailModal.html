<div class="modal fade" id="buildingDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg bg-light">
            <div class="modal-header bg-dark text-white p-3">
                <h5 class="modal-title fw-bold">
                    <i class="bi bi-factory me-2"></i>
                    <span id="det-name">é«˜çº§ç‚¼é’¢å‚</span>
                    <span class="badge bg-primary ms-2">Lv.<span id="det-level">3</span></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body p-0">
                <div class="row g-0">
                    <div class="col-lg-3 border-end p-4">
                        <section class="mb-4">
                            <h6 class="text-muted small fw-bold text-uppercase mb-3">å»ºç­‘è¯¦æƒ…</h6>
                            <div class="d-flex align-items-center mb-3">
                                <div class="fs-1 me-3" id="det-icon">ğŸ—ï¸</div>
                                <div>
                                    <div class="fw-bold">ç»´æŠ¤æˆæœ¬</div>
                                    <div class="text-danger">-$450/hr</div>
                                </div>
                            </div>
                            <div class="small text-muted">ç”Ÿäº§æ•ˆç‡:
                                <span class="text-dark fw-bold" id="current-rate">98%</span></div>
                        </section>

                        <hr>

                        <section class="mb-4">
                            <h6 class="text-muted small fw-bold text-uppercase mb-3">å»ºç­‘æ“ä½œ</h6>
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary btn-sm fw-bold" id="upgrade-building-btn">å‡çº§å»ºç­‘
                                    <span class="vr mx-2" style="height: 12px; opacity: 0.5;"></span>
                                    <span id="upgrade-cost" class="opacity-75">
        $0.00
    </span>
                                </button>
                                <button class="btn btn-outline-secondary btn-sm">æ¬è¿åœ°å—</button>
                                <button class="btn btn-outline-danger btn-sm" id="remove-building-btn">æŠ¥åºŸæ‹†é™¤</button>
                            </div>
                        </section>
                    </div>
                    <div class="col-lg-9 p-4 bg-white">
                        <h6 class="text-muted small fw-bold text-uppercase mb-3">æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡</h6>
                        <div class="d-flex align-items-center mb-3" id="building-task-container">
                            <span class="text-muted small">å½“å‰æ— è¿›è¡Œä¸­ä»»åŠ¡</span>
                        </div>
                        <h6 class="text-muted small fw-bold text-uppercase mb-3">å¯ç”Ÿäº§èµ„æºåˆ—è¡¨</h6>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle border">
                                <thead class="table-light">
                                <tr>
                                    <th>äº§å‡ºèµ„æº</th>
                                    <th>åŸæ–™</th>
                                    <th>äº§å‡º</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                                </thead>
                                <tbody id="production-list-container">
                                <tr>
                                    <td colspan="4" class="text-center py-5 text-muted">
                                        <div class="spinner-border spinner-border-sm me-2"></div>
                                        æ­£åœ¨åŠ è½½ç”Ÿäº§æ–¹æ¡ˆ...
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    <!-- å˜é‡ -->
    let levels;
    let playerBuilding;
    let productionRate;
</script>
<script>
    document.querySelector("#upgrade-building-btn").addEventListener("click", async function () {
        const buildingId = this.getAttribute("data-id");
        if (!buildingId) return;
        console.log("æ‰§è¡Œå‡çº§ï¼Œå»ºç­‘ ID:", buildingId);
        await upgradeBuilding(buildingId);
    });
    document.querySelector("#remove-building-btn").addEventListener("click", async function () {
        const buildingId = this.getAttribute("data-id");
        if (!buildingId) return;
        console.log("æ‹†é™¤ï¼Œå»ºç­‘ ID:", buildingId);
        await removeBuilding(buildingId);
    });

    async function removeBuilding(buildingId) {
        // å‡çº§
        const response = await fetch(`/api/buildings/remove/${buildingId}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
        });
        if (response.ok) {
            showToast("åˆ é™¤æˆåŠŸ")
// è·å– Modal å…ƒç´ 
            const modalElem = document.querySelector("#buildingDetailModal");

// è·å–æˆ–åˆ›å»º Bootstrap å®ä¾‹
            const modalInstance = bootstrap.Modal.getOrCreateInstance(modalElem);

// æ‰§è¡Œå…³é—­
            modalInstance.hide();

        } else {
            const err = await response.json();
            alert("åˆ é™¤å¤±è´¥: " + err.detail);
        }
        await loadBuildings()
    }

    async function upgradeBuilding(buildingId) {
        // å‡çº§
        const response = await fetch(`/api/buildings/upgrade/${buildingId}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
        });
        if (response.ok) {
            alert("å‡çº§æˆåŠŸï¼");

        } else {
            const err = await response.json();
            alert("å‡çº§å¤±è´¥: " + err.detail);
        }
        await loadBuildings()
    }

    document.querySelector("#buildingDetailModal").addEventListener("show.bs.modal", onModalShow);

    // å®šä¹‰å…·åå‡½æ•°ä»¥ä¾¿ç§»é™¤
    async function onModalShow(event) {

        // 1. è·å–ç‚¹å‡»çš„æŒ‰é’®
        const button = event.relatedTarget;
        // 2. æå– data-id (è¿™å°±æ˜¯å»ºç­‘å®ä¾‹ ID)
        const player_building_id = parseInt(button.getAttribute('data-id'));

        playerBuilding = playerBuildingInstances.find(p => p.id === player_building_id)
        levels = window.gameData.buildings.find(b => b.id === playerBuilding.building_meta_id).levels;
        productionRate = levels.find(l => l.level === playerBuilding.level).production_rate

        document.querySelector("#upgrade-building-btn").setAttribute("data-id", player_building_id)
        document.querySelector("#remove-building-btn").setAttribute("data-id", player_building_id)

        // 3. ä»å…¨å±€æ•°æ®ä¸­æŸ¥æ‰¾è¯¥å®ä¾‹å’Œå®ƒçš„å…ƒæ•°æ®
        const res = await fetch("/api/buildings/");
        const data = await res.json(); // å†æ¬¡ await ä»¥è§£ææ•°æ®
        const instance = data.find(pb => pb.id === player_building_id);
        console.log(instance)
        // æ‰¾åˆ°è¯¥å®ä¾‹å¯¹åº”çš„å»ºç­‘ç±»å‹å…ƒæ•°æ®
        const building_meta = window.gameData.buildings.find(b => b.id === instance.building_meta_id);
        if (!building_meta) return;

        // --- å¡«å……å·¦ä¾§ï¼šå»ºç­‘è¯¦æƒ… ---
        document.querySelector("#current-rate").innerText =  (productionRate * 100).toFixed(2) + "%";
        document.getElementById('det-name').textContent = building_meta.name;
        document.getElementById('det-level').textContent = instance.level || 99;
        document.getElementById('det-icon').innerHTML = `<i class="${building_meta.icon} me-2"></i>` || 'ğŸ—ï¸';
        document.querySelector("#upgrade-cost").innerText = `$${building_meta.levels.find(l => l.level === instance.level + 1).cost}`
        // è®¡ç®—ç»´æŠ¤æˆæœ¬ (å‡è®¾æ¯çº§å¢åŠ  50%)
        const maintenanceSection = document.querySelector('#det-icon').nextElementSibling;
        maintenanceSection.innerHTML = `
        <div class="fw-bold">ä½¿ç”¨æˆæœ¬ /å°æ—¶</div>
        <div class="text-danger">-$${building_meta.maintenance_cost || 0}/hr</div>
    `;
        // è¿›è¡Œä¸­çš„ä»»åŠ¡åˆ—è¡¨
        await refreshTaskDisplay(player_building_id);
        // --- å¡«å……å³ä¾§ï¼šç”Ÿäº§åˆ—è¡¨ ---
        renderProductionList(building_meta.id, player_building_id);
    }

    async function handleTaskComplete(playerBuildingId) {
        const response = await fetch(`/api/task/claim/${playerBuildingId}`);
        const data = await response.json()
        showToast(data.msg)
        await refreshTaskDisplay(playerBuildingId)
        await loadBuildings()
    }

    //
    async function refreshTaskDisplay(playerBuildingId) {
        try {
            // æ‰¾åˆ°ä½ åˆšæ‰å®šä¹‰çš„å®¹å™¨ (å‡è®¾ ID ä¸º task-container)
            const container = document.querySelector('#building-task-container');
            // 1. ä»ä½ çš„ FastAPI CRUD æ¥å£è¯·æ±‚æ•°æ®
            const response = await fetch(`/api/task/${playerBuildingId}`);
            if (response.status !== 200) {
                container.innerHTML = '<span class="text-muted small">å½“å‰æ— è¿›è¡Œä¸­ä»»åŠ¡</span>';
                const data = await response.text()
                console.error(data)
                return;
            }
            const task = await response.json();

            if (!task) {
                container.innerHTML = '<span class="text-muted small">å½“å‰æ— è¿›è¡Œä¸­ä»»åŠ¡</span>';
                return;
            }

            // 3. æ•°å­¦è®¡ç®—ï¼šè¿›åº¦ç™¾åˆ†æ¯”
            const now = new Date().getTime();
            const start = new Date(task.start_time).getTime();
            const end = new Date(task.end_time).getTime();
            const total = end - start;
            const elapsed = now - start;
            const progress = Math.min(100, Math.max(0, (elapsed / total) * 100));

            // è®¡ç®—å‰©ä½™ç§’æ•°
            const remainingSec = Math.max(0, Math.floor((end - now) / 1000));

            // 4. å¡«å…… HTML (ä½¿ç”¨ä½ åˆšæ‰é‚£ä¸€è¡Œçš„ç»“æ„)
            const resource = window.gameData.resources.find(r => r.id == task.resource_id)
            container.innerHTML = `
            <div class="flex-grow-1">
            <div class="d-flex justify-content-between align-items-center mb-1">
                <span class="fw-bold small">
                     ${renderIcon(resource.icon)}
                     ${resource.name}
                     <span>${task.task_type === 'upgrade' ? 'å»ºç­‘å‡çº§' : 'ç”Ÿäº§ä¸­'}</span>
                </span>

                ${remainingSec > 0
                ? `
                        <!-- æƒ…å†µ Aï¼šæœªå®Œæˆï¼Œæ˜¾ç¤ºå€’è®¡æ—¶å‹‹ç«  -->
                        <span class="badge rounded-pill bg-light text-primary border small">
                            ${formatRemainSec(remainingSec)}
                        </span>
                      `
                : `
                        <!-- æƒ…å†µ Bï¼šå·²å®Œæˆï¼Œæ˜¾ç¤ºé¢†å–æŒ‰é’® -->
                        <button
                            class="btn btn-primary btn-sm rounded-pill px-3 py-0"
                            style="font-size: 0.75rem;"
                            onclick="handleTaskComplete(${playerBuildingId})">
                            é¢†å–å¥–åŠ±
                        </button>
                      `
            }
                </div>

                <div class="progress" style="height: 6px;">
                    <div class="progress-bar progress-bar-striped ${remainingSec > 0 ? 'progress-bar-animated' : ''} bg-success"
                         role="progressbar"
                         style="width: ${progress}%"></div>
                </div>
                <div class="d-flex justify-content-between mt-1" style="font-size: 0.75rem;">
                    <span class="text-muted">äº§å‡º: <strong class="text-dark">+${task.quantity}</strong></span>
                    <span class="text-muted">è¿›åº¦: <span>${Math.floor(progress)}</span>%</span>
                </div>
            </div>
        `;

            // 5. å¦‚æœä»»åŠ¡åˆšå®Œæˆï¼Œå¯ä»¥è§¦å‘ä¸€æ¬¡è‡ªåŠ¨ç»“ç®—ï¼ˆæˆ–è€…æ˜¾ç¤ºé¢†å–æŒ‰é’®ï¼‰
            if (remainingSec === 0) {
                console.log("æ£€æµ‹åˆ°ä»»åŠ¡å®Œæˆï¼Œç­‰å¾…ç©å®¶é¢†å–...");
            }

        } catch (error) {
            console.error("æ— æ³•è·å–ä»»åŠ¡çŠ¶æ€:", error);
        }
    }

    /**
     * æ¸²æŸ“ç”Ÿäº§åˆ—è¡¨ (é…åˆ gameData)
     */
    function renderProductionList(buildingMetaId, playerBuildingId) {
        const container = document.getElementById('production-list-container');
        const recipes = window.gameData.recipes.filter(r => r.building_meta_id === buildingMetaId);

        if (!recipes || recipes.length === 0) {
            container.innerHTML = '<tr><td colspan="4" class="text-center py-5 text-muted">æ­¤å»ºç­‘ç›®å‰æ— å¯ç”Ÿäº§æ–¹æ¡ˆ</td></tr>';
            return;
        }

        container.innerHTML = recipes.map(recipe => {
            const outputRes = window.gameData.resources.find(r => r.id === recipe.output.id);
            const perHr = recipe.per_hour; // æ¯å°æ—¶äº§å‡ºåŸºæ•°

            return `
            <tr class="align-middle" data-recipe-id="${recipe.id}">
                <td class="py-3" style="width: 25%;">
                    <div class="d-flex align-items-center">
                        <div class="bg-primary bg-opacity-10 p-2 rounded me-3">
                            <span class="fs-4">${renderIcon(outputRes.icon)}</span>
                        </div>
                        <div>
                            <div class="fw-bold text-dark">${outputRes.name}</div>
                            <div class="text-muted" style="font-size: 0.7rem;">
                                ç”Ÿäº§é€Ÿç‡: <span id="production-rate" >${parseFloat(recipe.per_hour * productionRate).toFixed(2)}</span>  / å°æ—¶
                            </div>
                        </div>
                    </div>
                </td>

                <td style="width: 30%;">
                    <div id="recipe-materials-${recipe.id}" class="d-flex flex-column gap-1">
                        </div>
                </td>

                <td style="width: 25%;">
                    <div class="px-2">
                        <div class="input-group input-group-sm mb-2 shadow-sm">
                            <span class="input-group-text bg-light">æ—¶é•¿</span>
                            <input type="number" class="form-control text-center fw-bold"
                                   id="hr-input-${recipe.id}"
                                   oninput="updatePreview(${recipe.id})"
                                   value="0"
                                   min="0"
                                   max="48"
                             >
                            <span class="input-group-text bg-light">å°æ—¶</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center bg-light rounded px-2 py-1">
                            <small class="text-muted">é¢„è®¡æ€»äº§å‡º:</small>
                            <strong class="text-primary fs-5" id="preview-qty-${recipe.id}" ">0</strong>
                        </div>
                    </div>
                </td>

                <td style="width: 20%;" class="text-end">
                    <button class="btn btn-primary w-100 shadow-sm fw-bold py-2"
                            id="btn-start-${recipe.id}"
                            onclick="executeStartProduction(${recipe.id}, ${playerBuildingId})"
                            data-bs-dismiss="modal"
                            >
                        å¼€å§‹ç”Ÿäº§
                    </button>
                </td>
            </tr>`;
        }).join('');

        // åˆå§‹æ‰§è¡Œä¸€æ¬¡é¢„è§ˆæ›´æ–°ï¼Œå¡«å……ææ–™å’Œæ•°é‡
        recipes.forEach(r => updatePreview(r.id));
    }

    async function updatePreview(recipeId) {
        // tr
        const trElement = document.querySelector(`tr[data-recipe-id="${recipeId}"]`);
        const recipe = window.gameData.recipes.find(r => r.id === recipeId);
        const hours = parseFloat(trElement.querySelector(`#hr-input-${recipeId}`).value) || 0;

        // 1. è®¡ç®—äº§å‡º
        const perHr = recipe.per_hour;
        const production_rate = parseFloat(trElement.querySelector("#production-rate").textContent).toFixed(2)
        const totalOutput = Math.floor(hours * production_rate);
        console.log("render out: ", production_rate, hours, totalOutput)
        trElement.querySelector(`#preview-qty-${recipeId}`).innerText = totalOutput.toLocaleString();

        // 2. è®¡ç®—å¹¶æ¸²æŸ“ææ–™éœ€æ±‚
        const materialContainer = trElement.querySelector(`#recipe-materials-${recipeId}`);
        const startBtn = trElement.querySelector(`#btn-start-${recipeId}`);
        let canAfford = true;
        const resp = await fetch(`/api/inventory/`);
        const playerInventory = await resp.json()

        materialContainer.innerHTML = recipe.inputs.map((input) => {
            const res = window.gameData.resources.find(r => r.id === input.resource_id);
            const totalNeeded = Math.ceil(perHr * hours * input.quantity);
            const item = playerInventory.find(r => r.resource_id === input.resource_id)
            const currentStock = item ? item['quantity'] : 0
            const isShortage = currentStock < totalNeeded;

            if (isShortage) canAfford = false;

            return `
            <div class="d-flex justify-content-between align-items-center p-1 rounded ${isShortage ? 'bg-danger bg-opacity-10' : 'bg-light'}"
                 style="font-size: 0.85rem;">
                <span class="${isShortage ? 'text-danger fw-bold' : 'text-dark'}">
                    ${renderIcon(res.icon)} ${res.name}
                </span>
                <span class="small">
                    <span class="${isShortage ? 'text-danger fw-bold' : 'text-muted'}">${totalNeeded}</span>
                    <span class="text-secondary">/ åº“å­˜:${currentStock}</span>
                </span>
            </div>
        `;
        }).join('');

        // 3. è‡ªåŠ¨ç¦ç”¨æŒ‰é’®ï¼ˆå¦‚æœåº“å­˜ä¸è¶³ï¼‰
        if (!canAfford) {
            startBtn.classList.add('disabled');
            startBtn.innerText = 'åº“å­˜ä¸è¶³';
        } else {
            startBtn.classList.remove('disabled');
            startBtn.innerText = 'å¼€å§‹ç”Ÿäº§';
        }
    }

    /**
     * è§¦å‘å»ºç­‘ç”Ÿäº§ä»»åŠ¡
     * @param recipeId
     * @param playerBuildingId
     */
    async function executeStartProduction(recipeId, playerBuildingId) {
        const recipe = window.gameData.recipes.find(recipe => recipe.id === recipeId);

        // 1. æ„é€ ç¬¦åˆ BuildingTaskCreate Schema çš„æ•°æ®
        const now = new Date();
        const hours = parseFloat(document.querySelector(`#hr-input-${recipe.id}`).value);

        const quantity = parseInt(hours * recipe.per_hour)

        const taskData = {
            player_building_id: playerBuildingId,
            resource_id: recipe.output.id,
            quantity: quantity,
            start_time: now.toISOString(),
        };

        try {
            // 2. å‘é€è¯·æ±‚åˆ° FastAPI æ¥å£
            const response = await fetch('/api/task/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(taskData)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'ç”Ÿäº§å¯åŠ¨å¤±è´¥');
            }
        } catch (error) {
            console.error("ç”Ÿäº§é”™è¯¯:", error);
        }
        await loadBuildings()

    }
</script>

{% extends "layout.html" %}

{% block content %}
<div class="container-fluid py-3">
    <div class="card shadow-sm border-0">
        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
            <ul class="nav nav-tabs card-header-tabs border-bottom-0" id="contractTabs" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active fw-bold" id="received-tab" data-bs-toggle="tab"
                            data-bs-target="#received-pane">
                        ğŸ“© æ”¶åˆ°çš„æŠ¥ä»· <span class="badge bg-danger ms-1" id="count-received">0</span>
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link fw-bold text-secondary" id="sent-tab" data-bs-toggle="tab"
                            data-bs-target="#sent-pane">
                        ğŸ“¤ å‘å‡ºçš„åˆåŒ
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link fw-bold text-secondary" id="recurring-tab" data-bs-toggle="tab"
                            data-bs-target="#recurring-pane">
                        â³ å®šæœŸåˆåŒ
                    </button>
                </li>
            </ul>

            <div class="ms-auto">
                <button class="btn btn-primary btn-sm fw-bold shadow-sm" data-bs-toggle="modal"
                        data-bs-target="#newContractModal">
                    <i class="bi bi-plus-lg me-1"></i> å‘èµ·æ–°åˆåŒ
                </button>
                <button class="btn btn-outline-secondary btn-sm ms-2" onclick="ContractManager.fetchAll()">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
        </div>

        <div class="tab-content" id="contractTabsContent">
            <div class="tab-pane fade show active" id="received-pane" role="tabpanel">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="table-received">
                        <thead class="table-light small">
                        <tr>
                            <th>èµ„æº</th>
                            <th>å‘ä»¶æ–¹</th>
                            <th>å“è´¨</th>
                            <th>æ•°é‡</th>
                            <th>å•ä»·</th>
                            <th>æ€»é¢</th>
                            <th class="text-end">æ“ä½œ</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="sent-pane" role="tabpanel">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="table-sent">
                        <thead class="table-light small">
                        <tr>
                            <th>èµ„æº</th>
                            <th>æ¥æ”¶æ–¹</th>
                            <th>å“è´¨</th>
                            <th>æ•°é‡</th>
                            <th>å•ä»·</th>
                            <th>æ€»é¢</th>
                            <th class="text-end">æ“ä½œ</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="recurring-pane" role="tabpanel">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="table-recurring">
                        <thead class="table-light small">
                        <tr>
                            <th>èµ„æº</th>
                            <th>å¯¹æ–¹å…¬å¸</th>
                            <th>å“è´¨</th>
                            <th>æ¯æ—¥ä¾›åº”é‡</th>
                            <th>åè®®å•ä»·</th>
                            <th>çŠ¶æ€</th>
                            <th class="text-end">æ“ä½œ</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="newContractModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title">ğŸ“¦ å‘èµ·æ–°å•†ä¸šåˆåŒ</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="contractForm">
                <div class="modal-body">
                    <!-- æ¥æ”¶æ–¹ -->
                    <div class="mb-3">
                        <label class="form-label small fw-bold">æ¥æ”¶æ–¹å…¬å¸ ID</label>
                        <input type="number" name="receiver_id" class="form-control"
                               placeholder="è¾“å…¥å…¬å¸å”¯ä¸€æ•°å­— ID..." required>
                    </div>

                    <!-- èµ„æºä¸å“è´¨ -->
                    <div class="row g-2 mb-3">
                        <div class="col-8">
                            <label class="form-label small fw-bold">èµ„æºåç§°</label>
                            <select class="form-select" name="resource_id" id="contract-resource" required>
                                <option value="" selected disabled>åŠ è½½ä¸­...</option>
                            </select>
                        </div>
                    </div>

                    <!-- æ•°é‡ä¸å•ä»· -->
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="form-label small fw-bold">æ•°é‡</label>
                            <input type="number" name="quantity" id="contract-qty" class="form-control" placeholder="0"
                                   required min="1">
                        </div>
                        <div class="col-6">
                            <label class="form-label small fw-bold">å•ä»· ($)</label>
                            <input type="number" name="price_per_unit" id="contract-price" class="form-control"
                                   step="0.001" required min="0.001">
                        </div>
                    </div>

                    <!-- æ€»è®¡æ˜¾ç¤º (æ–°å¢) -->
                    <div class="alert alert-secondary py-2 mb-3 d-flex justify-content-between align-items-center">
                        <span class="small fw-bold text-muted">åˆåŒé¢„è®¡æ€»é¢:</span>
                        <div>
                            <span class="h6 mb-0 text-primary" id="contract-total">$0.00</span>
                            <!-- éšè—åŸŸï¼šç”¨äºè·Ÿéšè¡¨å•æäº¤ -->
                            <input type="hidden" name="total_amount" id="contract-total-input" value="0">
                        </div>
                    </div>


                    <!-- è¿‡æœŸæ—¶é—´ -->
                    <div class="mb-3">
                        <label class="form-label small fw-bold">æŠ¥ä»·æœ‰æ•ˆæœŸ (è¿‡æœŸæ—¶é—´)</label>
                        <input type="datetime-local" name="expires_at" id="addExpireAt" class="form-control" required>
                    </div>

                    <!-- åˆåŒç±»å‹åˆ‡æ¢ -->
                    <div class="card bg-light border-0">
                        <div class="card-body py-2">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="is_recurring" id="recurringCheck">
                                <label class="form-check-label fw-bold small" for="recurringCheck">
                                    è®¾ç½®ä¸ºå®šæœŸåˆåŒ (æœŸè´§)
                                </label>
                            </div>
                            <div id="recurringInfo" class="small text-muted mt-1 d-none">
                                <i class="bi bi-info-circle"></i> å¼€å¯åï¼Œç³»ç»Ÿå°†åœ¨æ¯å¤©ç›¸åŒæ—¶é—´è‡ªåŠ¨å°è¯•æ‰§è¡Œæ­¤äº¤æ˜“ã€‚
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">å‘é€åˆåŒæŠ¥ä»·</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}
{% block scripts %}
<script>

    document.addEventListener("DOMContentLoaded",async () => {
        await window.gameDataPromise
        const modalEl = document.getElementById('newContractModal');
        const form = document.getElementById('contractForm');
        const resourceSelect = document.querySelector("#contract-resource");
        const recurringCheck = document.querySelector("#recurringCheck");
        const recurringInfo = document.querySelector("#recurringInfo");
        console.log("1111", window.gameData)

        // 1. å½“æ¨¡æ€æ¡†æ˜¾ç¤ºæ—¶ï¼šå¡«å……èµ„æºä¸‹æ‹‰æ¡† + è®¾ç½®é»˜è®¤æ—¶é—´
        modalEl.addEventListener('show.bs.modal', () => {
            // æ¸²æŸ“èµ„æº
            console.log(window.gameData.resources)
            if (window.gameData?.resources) {
                resourceSelect.innerHTML = window.gameData.resources.map(res =>
                    `<option value="${res.id}">${res.name}</option>`
                ).join('');
            }

            // è®¾ç½®é»˜è®¤è¿‡æœŸæ—¶é—´ä¸º 24 å°æ—¶å
            const tomorrow = new Date();
            tomorrow.setHours(tomorrow.getHours() + 24);
            // æ ¼å¼åŒ–ä¸º datetime-local æ”¯æŒçš„å­—ç¬¦ä¸² YYYY-MM-DDTHH:MM
            document.getElementById('addExpireAt').value = tomorrow.toISOString().slice(0, 16);
        });

        // 2. ç›‘å¬æ€»ä»·è®¡ç®—
        const qtyInput = document.getElementById('contract-qty');
        const priceInput = document.getElementById('contract-price');
        const totalDisplay = document.getElementById('contract-total');
        const totalInput = document.getElementById("contract-total-input");

        [qtyInput, priceInput].forEach(input => {
            input.addEventListener('input', () => {
                const total = (qtyInput.value || 0) * (priceInput.value || 0);
                totalDisplay.innerText = `$${total.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
                totalInput.value = total;
            });
        });

        // 3. åˆ‡æ¢å®šæœŸåˆåŒ UI
        recurringCheck.addEventListener('change', (e) => {
            recurringInfo.classList.toggle('d-none', !e.target.checked);
        });

        // 4. è¡¨å•æäº¤é€»è¾‘
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const payload = Object.fromEntries(formData.entries());
            console.log("payload", payload)
            // æ˜¾å¼è½¬æ¢ç±»å‹
            payload.receiver_id = parseInt(payload.receiver_id);
            payload.resource_id = parseInt(payload.resource_id);
            payload.quantity = parseInt(payload.quantity);
            payload.price_per_unit = parseFloat(payload.price_per_unit);
            payload.total_amount = parseFloat(payload.total_amount)
            try {
                // ç¤ºä¾‹ API è¯·æ±‚
                const response = await fetch('/api/contract/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    alert("åˆåŒå·²æˆåŠŸå‘é€ï¼");
                    bootstrap.Modal.getInstance(modalEl).hide();
                    form.reset();
                } else {
                    const err = await response.json();
                    alert("å‘é€å¤±è´¥: " + err.detail);
                }
            } catch (error) {
                console.error("æäº¤å‡ºé”™:", error);
            }
        });
    });

</script>
<script>
    /**
     * æ¨¡æ‹Ÿæ ¹æ®è§†å›¾ç±»å‹åŠ è½½æ•°æ®
     */
    function switchView(type) {
        const menuItems = document.querySelectorAll('#contract-menu .list-group-item');

        menuItems.forEach(item => {
            item.addEventListener('click', function () {
                // 1. ç§»é™¤æ‰€æœ‰é¡¹çš„ active ç±»
                menuItems.forEach(i => i.classList.remove('active'));

                // 2. ä¸ºå½“å‰ç‚¹å‡»é¡¹æ·»åŠ  active ç±»
                this.classList.add('active');

                // 3. è·å–ä¸šåŠ¡ç±»å‹å¹¶æ‰§è¡ŒåŠ è½½é€»è¾‘
                const viewType = this.getAttribute('data-view');
                console.log(`åˆ‡æ¢åˆ°è§†å›¾: ${viewType}`);

                switchView(viewType);
            });
        });
        // è¿™é‡Œè°ƒç”¨ä½ çš„ FastAPI æ¥å£
        // ä¾‹å¦‚: if (type === 'received') fetchReceivedContracts();
        if (type === 'received') {
            console.log("åŠ è½½æ”¶åˆ°çš„åˆåŒæ•°æ®...");
        } else if (type === 'sent') {
            console.log("åŠ è½½å·²å‘é€çš„åˆåŒæ•°æ®...");
        }
    }

</script>

<script>
    const ContractHandler = {
        // å¯¹åº” sub_type: "contract_new"
        handleNew(data) {
            console.log("å¤„ç†æ–°åˆåŒæé†’:", data);
            // æ›´æ–°åˆåŒåˆ—è¡¨çš„å°çº¢ç‚¹
            const badge = document.getElementById('count-received');
            badge.innerText = parseInt(badge.innerText) + 1;
            // å¼¹å‡ºå…¨å±€é€šçŸ¥ï¼ˆToastï¼‰
            Toast.show(`æ”¶åˆ°æ¥è‡ª ${data.from} çš„æ–°åˆçº¦æŠ¥ä»·`);
        },

        // å¯¹åº” sub_type: "contract_update"
        handleUpdate(data) {
            console.log("åˆåŒçŠ¶æ€æ›´æ–°:", data);
            ContractManager.fetchAll(); // åˆ·æ–°è¡¨æ ¼
        }
    };
    const ContractManager = {
        // å®é™…åº”é€šè¿‡ window.player.id ç­‰å…¨å±€çŠ¶æ€è·å–ï¼Œç¡®ä¿æ˜¯ Number ç±»å‹
        currentUserId: 1,

        // çŠ¶æ€æ˜ å°„ï¼Œå¯¹åº”ä½ ä¹‹å‰åœ¨ CSS ä¸­å®šä¹‰çš„æ ·å¼
        icons: {'ç”µåŠ›': 'bi-lightning-charge', 'æ°´': 'bi-droplet', 'åŸæ²¹': 'bi-fuel-pump'},
        colors: {'ç”µåŠ›': 'warning', 'æ°´': 'primary', 'åŸæ²¹': 'dark'},

        async fetchAll() {
            try {
                const resp = await fetch("/api/player/me");
                const player = await resp.json();
                this.currentUserId = player.id;
                const response = await fetch('/api/contract/');
                if (!response.ok) throw new Error("è·å–æ•°æ®å¤±è´¥");
                const data = await response.json();

                // ä¿®æ­£ï¼šåç«¯è¿”å›çš„ ID é€šå¸¸æ˜¯ intï¼Œç¡®ä¿æ¯”è¾ƒé€»è¾‘ä¸€è‡´
                const uid = Number(this.currentUserId);

                // æ•°æ®è¿‡æ»¤é€»è¾‘
                const received = data.filter(c => c.receiver_id === uid && c.status === 'pending');
                const sent = data.filter(c => c.sender_id === uid && c.status === 'pending');
                // æœŸè´§ï¼šå‡è®¾ status ä¸º 'signed' ä¸” is_recurring ä¸º true
                const recurring = data.filter(c => c.is_recurring === true && (c.status === 'signed' || c.status === 'active'));
                console.log(data, received, sent)
                // æ‰§è¡Œæ¸²æŸ“
                this.renderTable('table-received', received, 'received');
                this.renderTable('table-sent', sent, 'sent');
                this.renderTable('table-recurring', recurring, 'recurring');

                // æ›´æ–°å¯¼èˆªæ¡ä¸Šçš„çº¢ç‚¹è®¡æ•°
                this.updateBadges({
                    'received': received.length,
                    'recurring': recurring.length
                });

            } catch (e) {
                console.error("ContractManager Error:", e);
                // å¯ä»¥åœ¨ UI ä¸Šæ˜¾ç¤ºé”™è¯¯æç¤º
            }
        },

        // ç”Ÿæˆèµ„æºåˆ—çš„æ¨¡æ¿ï¼ˆåŒ…å«å›¾æ ‡å’Œåç§°ï¼‰
        getItemTemplate(c) {
            // å‡è®¾åç«¯è¿”å›äº† resource_nameï¼Œå¦‚æœæ²¡æœ‰ï¼Œéœ€è¦æ ¹æ® ID æ˜ å°„
           const resource = window.gameData.resources.filter(r => r.id === c.resource_id)[0];
            const name = resource.name|| "æœªçŸ¥èµ„æº";
            const icon = this.icons[name] || 'bi-box-seam';
            const color = this.colors[name] || 'secondary';
            return `
            <div class="d-flex align-items-center">
                <div class="icon-box bg-${color}-subtle text-${color} rounded me-2" style="padding: 4px 8px;">
                    <i class="bi ${icon}"></i>
                </div>
                <div>
                    <div class="fw-bold">${name}</div>
                    <div class="text-muted" style="font-size: 0.7rem;">#${c.contract_no || c.id}</div>
                </div>
            </div>`;
        },

        renderTable(tableId, list, mode) {
            const table = document.querySelector(`#${tableId}`);
            if (!table) return;

            const tbody = table.querySelector(`tbody`);
            if (!list || list.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-muted">æš‚æ— åˆåŒæ•°æ®</td></tr>`;
                return;
            }

            tbody.innerHTML = list.map(c => `
            <tr class="align-middle">
                <td>${this.getItemTemplate(c)}</td>
                <td>
                    <span class="fw-bold text-dark">${mode === 'received' ? 'æ¥è‡ª ID: ' + c.sender_id : 'å‘é€è‡³ ID: ' + c.receiver_id}</span>
                    <div class="text-muted small">å“è´¨: Q${c.quality || 0}</div>
                </td>
                <td><span class="badge bg-light text-dark border">Q${c.quality}</span></td>
                <td>${Number(c.quantity).toLocaleString()}</td>
                <td class="text-success">$${Number(c.price_per_unit).toFixed(3)}</td>
                <td class="fw-bold">$${Number(c.total_amount).toLocaleString()}</td>
                <td class="text-end">${this.getActionButtons(c, mode)}</td>
            </tr>
        `).join('');
        },

        getActionButtons(c, mode) {
            // ä½¿ç”¨ data-id å±æ€§ä»£æ›¿ç›´æ¥åœ¨ onclick é‡Œä¼ å‚ï¼Œæ›´å®‰å…¨ä¸”ç¬¦åˆç°ä»£è§„èŒƒ
            if (mode === 'received') {
                return `
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-success" onclick="ContractManager.handleAction(${c.id}, 'accept')">ç­¾ç½²</button>
                    <button class="btn btn-outline-danger" onclick="ContractManager.handleAction(${c.id}, 'reject')">æ‹’ç»</button>
                </div>`;
            } else if (mode === 'sent') {
                return `<button class="btn btn-sm btn-outline-secondary" onclick="ContractManager.handleAction(${c.id}, 'cancel')">æ’¤å›</button>`;
            } else {
                return `<button class="btn btn-sm btn-danger" onclick="ContractManager.handleAction(${c.id}, 'terminate')">ç»ˆæ­¢åè®®</button>`;
            }
        },

        updateBadges(counts) {
            // åŠ¨æ€æ›´æ–°ä¾§è¾¹æ æˆ–å¯¼èˆªæ çš„æ•°å­—
            if (counts.received !== undefined) {
                const el = document.getElementById('count-received');
                if (el) el.innerText = counts.received;
            }
        },

        async handleAction(contractId, action) {
            // 2026 å‹å¥½æç¤ºï¼šæ ¹æ®ä¸åŒåŠ¨ä½œæ˜¾ç¤ºä¸åŒæ–‡æ¡ˆ
            const actionMap = {'accept': 'ç­¾ç½²å¹¶æ‰§è¡Œ', 'reject': 'æ‹’ç»', 'cancel': 'æ’¤å›', 'terminate': 'ç»ˆæ­¢'};
            if (!confirm(`ç¡®å®šè¦ ${actionMap[action] || action} è¿™ä»½åˆåŒå—ï¼Ÿ`)) return;

            try {
                // æ³¨æ„ï¼šAPI è·¯å¾„åº”ä¸åç«¯åŒ¹é…ã€‚æ­¤å¤„å‡è®¾åç«¯è·¯å¾„ä¸º /api/contract/{id}/{action}
                const response = await fetch(`/api/contract/${contractId}/${action}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                const result = await response.json();

                if (response.ok) {
                    // å±€éƒ¨æç¤ºï¼ˆå»ºè®®ä½¿ç”¨ Toast ä»£æ›¿ Alertï¼‰
                    console.log("æ“ä½œæˆåŠŸ");
                    this.fetchAll(); // åˆ·æ–°æ•°æ®

                    // WebSocket è”åŠ¨é€»è¾‘
                    if (window.gameChat?.socket?.readyState === WebSocket.OPEN) {
                        window.gameChat.socket.send(JSON.stringify({
                            type: "contract_notification",
                            action: action,
                            target_id: result.sender_id === this.currentUserId ? result.receiver_id : result.sender_id
                        }));
                    }
                } else {
                    alert(`é”™è¯¯: ${result.detail || 'æ“ä½œå¤±è´¥'}`);
                }
            } catch (error) {
                console.error("HandleAction Error:", error);
                alert("ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·ç¨åå†è¯•");
            }
        }

    };

    // åˆå§‹åŒ–ï¼šç¡®ä¿åœ¨ DOM å’Œæ¸¸æˆæ•°æ®åŠ è½½å®Œæˆåæ‰§è¡Œ
    document.addEventListener('DOMContentLoaded',async () => {
        // å¦‚æœä½ æœ‰è‡ªå®šä¹‰çš„åˆå§‹åŒ–äº‹ä»¶
        await window.gameDataPromise
        await ContractManager.fetchAll();
    });


</script>
{% endblock %}

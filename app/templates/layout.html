<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ company_name }} - SimEcon</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it-texmath/texmath.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

    <style>
        :root {
            --navbar-height: 50px;
            --sidebar-width: 50px;
        }

        . {
            box-sizing: border-box;
        }

        body,
        html {
            height: 100%;
            margin: 0;
        }

        /* 导航项样式 */
        .nav-link-custom {
            color: #6c757d;
            text-decoration: none;
            font-size: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex: 1;
            /* 均分空间 */
        }

        /* 激活状态：变色并带有小圆点或发光效果 */
        .nav-link-custom.active {
            color: #0d6efd;
            position: relative;
        }

        .nav-link-custom.active::after {
            content: '';
            position: absolute;
            bottom: 5px;
            width: 5px;
            height: 5px;
            background: #0d6efd;
            border-radius: 50%;
        }

        .nav-link-custom:hover {
            color: #0d6efd;
            transform: translateY(-2px);
        }

        /* 侧边栏基础容器 */
        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            left: 0;
            top: var(--navbar-height);
            background-color: #fffdf0;
            /* 极淡的奶油黄 */
            border-right: 2px solid #f0e68c;
            /* 淡淡的卡其色边框 */
            z-index: 1000;
            transition: width 0.3s ease;
            overflow-x: hidden;
        }

        /* 链接基础样式 */
        .nav-link-custom {
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            padding: 12px;
            border-radius: 15px;
            /* 圆角增加柔和感 */
            color: #8c7b60;
            /* 柔和的木质棕 */
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        /* 图标大小 */
        .nav-link-custom i {
            font-size: 1.4rem;
        }

        /* 文本默认隐藏，展开时显示 */
        .nav-text {
            margin-left: 10px;
            opacity: 0;
            font-size: 0.9rem;
            transition: opacity 0.2s;
        }

        .sidebar:hover .nav-text {
            opacity: 1;
        }

        /* 悬停与选中状态 - 温暖的亮黄色 */
        .nav-link-custom:hover,
        .nav-link-custom.active {
            background-color: #fef3c7;
            /* 暖阳黄 */
            color: #d97706;
            /* 琥珀色深色 */
        }

        main {
            margin-left: var(--sidebar-width) !important;
        }
    </style>
    <script>
        const md = window.markdownit({
            html: true,
            breaks: true
        }).use(texmath, {
            engine: katex,
            delimiters: 'dollars'
        });

    </script>
    <style>
        /* 让进度条变化像水流一样顺滑 */
        #solar-wave {
            transition: width 3s ease-in-out;
        }

        /* 降低跑马灯的亮度，保护视力 */
        #news-scroll {
            color: #8a857a !important;
            /* 一种更温和的深灰色 */
            /* 将 10s 改为 30s 或更高，数字越大速度越慢 */

        }
    </style>
    <style>
        .news-ticker-content {
            display: inline-block;
            white-space: nowrap;
            padding-left: 100%;
            /* 从最右侧开始 */
            animation: ticket-scroll 40s linear infinite;
            /* 30秒一圈，非常缓慢 */
            line-height: 20px;
            font-size: 0.75rem;
        }

        /* 鼠标悬停时暂停，方便阅读 */
        .news-ticker-content:hover {
            animation-play-state: paused;
        }

        @keyframes ticket-scroll {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(-100%);
            }
        }
    </style>

</head>

<body class="d-flex flex-column">
    <!-- 顶部状态栏保持不变 -->
    <nav class="navbar navbar-expand-lg fixed-top py-0 border-bottom border-warning border-opacity-25 shadow-sm"
        style="height: 52px; background: #F7F3E9 !important;">
        <div class="container-fluid px-4 h-100 font-monospace">

            <div class="d-flex align-items-center pe-4 border-end border-dark border-opacity-10 h-100">
                <i class="bi bi-person-circle text-warning me-2 fs-5"></i>
                <span id="player-name" class="fw-bold text-dark small">NAN</span>
            </div>

            <div class="flex-grow-1 d-flex justify-content-center align-items-center gap-5">

                <div class="d-flex align-items-center gap-2" data-bs-toggle="tooltip" title="太阳活动强度，0-5">
                    <i class="bi bi-sun-fill text-warning fs-6"></i>
                    <span id="solar-index" class="fw-bold text-dark small" style="min-width: 40px;">0</span>
                    <div class="bg-warning bg-opacity-20 rounded-pill" style="width: 30px; height: 3px;">
                        <div id="solar-wave" class="progress-bar bg-warning opacity-75 w-75"></div>
                    </div>
                </div>

                <div class="bg-white bg-opacity-50 border border-warning border-opacity-20 rounded-pill px-3 py-1 d-flex
                align-items-center" style="width: 320px;">
                    <i class="bi bi-broadcast text-warning me-2 small" data-bs-toggle="tooltip" title="宇宙预警信息"></i>
                    <div class="flex-grow-1 position-relative overflow-hidden">
                        <div id="news-scroll" class="news-ticker-content text-muted small">
                            [实时观测] 太阳活动平稳 ● 数据链路同步中 ● 月影正向西偏移 ●
                        </div>
                    </div>
                </div>

                <div class="d-flex align-items-center gap-2" data-bs-toggle="tooltip" title="地月距离">
                    <i class="bi bi-moon-stars-fill text-warning opacity-50 fs-6"></i>
                    <span id="lunar-dist" class="text-dark fw-bold small">36.3w km</span>
                </div>

            </div>

            <div class="d-flex align-items-center ps-4 border-start border-dark border-opacity-10 gap-4">

                <div class="d-flex align-items-center gap-2">
                    <i class="bi bi-wallet2 text-success opacity-75"></i>
                    <span id="player-cash" class="text-dark fw-bold small">$000.00</span>
                </div>

            </div>
        </div>
    </nav>

    <div class="d-flex flex-grow-1">
        <aside class="sidebar position-fixed start-0 vh-100 shadow-sm d-flex flex-column align-items-center py-3 mt-5"
            style="width: 60px; background-color: #F7F3E9; z-index: 1020; top:0; border-right: 1px solid rgba(212, 163, 115, 0.2);">

            <nav class="nav flex-column gap-2 w-100 px-1">
                <a href="/landscape"
                    class="nav-link-custom text-center rounded-3 p-2 {% if active_page == 'landscape' %}active{% endif %}"
                    title="总部">
                    <i class="bi bi-map fs-5"></i>
                </a>
                <a href="/exchange"
                    class="nav-link-custom text-center rounded-3 p-2 {% if active_page == 'exchange' %}active{% endif %}"
                    title="交易所">
                    <i class="bi bi-currency-exchange fs-5"></i>
                </a>
                <a href="/contract"
                    class="nav-link-custom text-center rounded-3 p-2 {% if active_page == 'contracts' %}active{% endif %}"
                    title="合同">
                    <i class="bi bi-file-earmark-text fs-5"></i>
                </a>
                <a href="/inventory"
                    class="nav-link-custom text-center rounded-3 p-2 {% if active_page == 'inventory' %}active{% endif %}"
                    title="仓库">
                    <i class="bi bi-box-seam fs-5"></i>
                </a>
                <a href="/chat"
                    class="nav-link-custom text-center rounded-3 p-2 {% if active_page == 'chat' %}active{% endif %}"
                    title="聊天">
                    <i class="bi bi-chat-dots fs-5"></i>
                </a>
                <a href="/economic"
                    class="nav-link-custom text-center rounded-3 p-2 {% if active_page == 'economic' %}active{% endif %}"
                    title="经济">
                    <i class="bi bi-graph-up-arrow fs-5"></i>
                </a>
                <a href="/journal"
                    class="nav-link-custom text-center rounded-3 p-2 {% if active_page == 'journal' %}active{% endif %}"
                    title="日志">
                    <i class="bi bi-journal fs-5"></i>
                </a>
                <a href="/personal/"
                    class="nav-link-custom text-center rounded-3 p-2 mt-4 {% if active_page == 'personal' %}active{% endif %}"
                    title="我的">
                    <i class="bi bi-person fs-5"></i>
                </a>
            </nav>
        </aside>
        <!-- 主内容区域：底部需要留出导航栏的高度 -->
        <main class="flex-grow-1">
            <div class=" container-fluid overflow-hidden pt-5 pb-5">
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>

    <div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>系统设置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>版本: 0.1.0-alpha</p>
                    <button class="btn btn-danger w-100">退出公司管理</button>
                </div>
            </div>
        </div>
    </div>
    {% include 'components/toast.html' %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/global.js"></script>


    <script>
        document.addEventListener('DOMContentLoaded', async () => {

            await fetch("/api/player/me").then(async (res) => {
                const player = await res.json()
                document.querySelector("#player-cash").innerText = `$${player.cash.toFixed(2)}`
            }).catch(e => {
                alert(e)
            })
            document.querySelector("#player-name").innerText = getUserInfo().name
            gameWS.subscribe("player", (msg) => {
                const sub_type = msg.sub_type;
                const data = msg.data
                if (sub_type === "update_cash") {
                    document.querySelector("#player-cash").innerText = `$${data.cash.toFixed(2)}`
                }
            })

        });

    </script>
    <script>
        // 在 render 函数中给数值加一点微小的视觉抖动
        function applyGentleJitter(elementId, baseValue) {
            const el = document.getElementById(elementId);
            setInterval(() => {
                const jitter = (Math.random() - 0.5) * 0.001;
                el.innerText = (parseFloat(baseValue) + jitter).toFixed(2);
            }, 500);
        }

        let summarizer = null;
        /**
         * 真实深空数据同步引擎
         */
        const RealSpaceAPI = {
            // 1. 获取真实太阳与地磁活动 (NOAA 实时数据)
            async syncSolarActivity() {
                try {
                    // 获取 NOAA 的实时等级 (R:无线电, S:太阳辐射, G:地磁)
                    const response = await fetch('https://services.swpc.noaa.gov/products/noaa-scales.json');
                    const data = await response.json();
                    const today = data[0]
                    console.log(today);

                    // 我们取 R (无线电干扰) 作为你的 Solar Index
                    const radioScale = parseInt(today.R.Scale); // 0-5 级
                    const solarVal = (1.0 + (radioScale * 0.2)).toFixed(2); // 映射到 1.0-2.0 范围

                    document.getElementById('solar-index').innerText = solarVal;

                    // 更新进度条宽度
                    const percentage = (radioScale / 5) * 100 + 20;
                    document.getElementById('solar-wave').style.width = percentage + "%";

                    return radioScale;
                } catch (error) {
                    console.error("无法同步太阳数据:", error);
                    return 0;
                }
            },


            // 3. 计算此时此刻真实的月球距离 (精确到KM)
            syncLunarDistance() {
                // 使用简化的月球轨道偏心率公式，基于 Unix 时间戳计算
                const now = new Date();
                const t = (now.getTime() / 1000 / 86400) + 2440587.5;
                const dist = 385000.56 - 20905.35 * Math.cos((134.963 + 13.064993 * (t - 2451545.0)) * Math.PI / 180);

                // 国际化处理：使用本地化数字格式 (例如: 384,400 km)
                const formattedDist = Math.floor(dist).toLocaleString('en-US');
                document.getElementById('lunar-dist').innerText = `${formattedDist} km`;
            }
            ,
            async fetchAndRenderNews() {
                const newsScroll = document.getElementById('news-scroll');

                try {
                    // 1. 从你的后端获取通告
                    const response = await fetch('/api/news');
                    const notices = await response.json();

                    if (notices.length === 0) {
                        newsScroll.innerText = "● 远方一切安静，阳光铺满麦田 ●";
                        return;
                    }

                    // 2. 格式化通告（加上时间戳和前缀，增加代入感）
                    const formattedNews = notices.map(item => {
                        // 1. 24小时制极简时间，去掉秒，更稳重
                        const d = new Date(item.time);
                        // 格式化为 02/03 10:15
                        const dateStr = `${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getDate().toString().padStart(2, '0')}`;
                        const timeStr = d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });

                        // 2. 统一标签长度：让 [信息] [警告] 宽度一致，滚动时视觉不跳动
                        const typeLabel = item.type.padEnd(2, ' ');

                        // 3. 使用特定的分割符，模拟旧式显示器的点阵感
                        return `${dateStr} ${timeStr} | ${typeLabel} | ${item.content}`;
                    }).join("  ●  "); // 用双斜杠或空隙较大的符号分隔不同条目


                    // 3. 渲染并确保滚动流畅
                    // 加上结尾符，让循环滚动时首尾呼应
                    newsScroll.innerText = `● ${formattedNews} ● `;

                } catch (error) {
                    console.error("无法同步电台信号:", error);
                    newsScroll.innerText = "● 电台信号同步中，请静候片刻 ●";
                }
            },

            // 4. 定时轮询逻辑
            init() {
                this.fetchAndRenderNews()

                // 初始同步
                this.syncSolarActivity();
                this.syncLunarDistance();


                // 太阳数据和消息每 60 分钟更新一次（API 限制，不建议太快）
                setInterval(() => this.syncSolarActivity(), 1000 * 60 * 60);
                // 月球距离每秒都在变
                setInterval(() => this.syncLunarDistance(), 1000);
            }
        }
            ;

        // 页面加载完成后启动
        document.addEventListener('DOMContentLoaded', () => RealSpaceAPI.init());
    </script>

    {% block scripts %}
    {% endblock %}
</body>

</html>
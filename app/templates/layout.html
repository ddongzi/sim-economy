<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ company_name }} - SimEcon</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --sidebar-width: 50px;
            --navbar-height: 60px;
        }

        . {
            box-sizing: border-box;
        }

        body, html {
            height: 100%;
            margin: 0;
        }

        /* ä¸»ä½“å†…å®¹åŒºå®¹å™¨ */
        .main-wrapper {
            margin-left: 0 !important; /* å–æ¶ˆåŸä¾§è¾¹æ ç•™ç™½ */
            width: 100%;
            display: flex;
            flex-direction: column;
            height: 100vh; /* å¼ºåˆ¶å æ»¡æ•´ä¸ªå±å¹•ï¼Œä¸éšå†…å®¹å˜é•¿ */
            overflow: hidden; /* é˜²æ­¢å¤–å±‚å‡ºç°æ»šåŠ¨æ¡ */
        }
        /* é¡¶éƒ¨çŠ¶æ€æ  */
        .game-navbar {
            height: var(--navbar-height);
            background-color: #2c3e50;
            border-bottom: 1px solid #34495e;
            padding: 0 20px;
            flex-shrink: 0; /* å…³é”®ï¼šç¦æ­¢å¯¼èˆªæ è¢«æŒ¤å‹å˜çŸ® */
            /* å…³é”®ä¿®å¤ */
            position: fixed; /* å›ºå®šåœ¨å±å¹•ä¸Š */
            top: 0; /* è´´é¡¶ */
            left: 0;
            right: 0; /* ç»“æŸä½ç½®ï¼šå±å¹•æœ€å³ä¾§ */
            z-index: 1030; /* ç¡®ä¿åœ¨æ‰€æœ‰å…ƒç´ ä¹‹ä¸Šï¼ŒBootstrap 5 çš„æ ‡å‡†å±‚çº§ */
        }


        /* ç§»é™¤ Bootstrap Container é»˜è®¤å¤–è¾¹è· */
        .game-content {
            flex-grow: 1;
            position: relative;
            padding-top: var(--navbar-height);
            min-height: calc(100vh - 115px); /* 100vh - é¡¶éƒ¨50 - åº•éƒ¨65 */
            overflow-y: auto; /* åªæœ‰å†…å®¹åŒºåŸŸå¯ä»¥æ»šåŠ¨ */
        }


        /* å¯¼èˆªé¡¹æ ·å¼ */
        .nav-link-custom {
            color: #6c757d;
            text-decoration: none;
            font-size: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex: 1; /* å‡åˆ†ç©ºé—´ */
        }

        /* æ¿€æ´»çŠ¶æ€ï¼šå˜è‰²å¹¶å¸¦æœ‰å°åœ†ç‚¹æˆ–å‘å…‰æ•ˆæœ */
        .nav-link-custom.active {
            color: #0d6efd;
            position: relative;
        }

        .nav-link-custom.active::after {
            content: '';
            position: absolute;
            bottom: 5px;
            width: 5px;
            height: 5px;
            background: #0d6efd;
            border-radius: 50%;
        }

        .nav-link-custom:hover {
            color: #0d6efd;
            transform: translateY(-2px);
        }

        /* åº•éƒ¨å¯¼èˆªæ å®¹å™¨ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 65px;
            background: #ffffff;
            border-top: 1px solid #dee2e6;
            z-index: 1030;
            padding-bottom: env(safe-area-inset-bottom); /* é€‚é… 2026 æ‰‹æœºå…¨é¢å±åº•è¾¹ */
        }

    </style>
    <script>
        // å®šä¹‰ä¸€ä¸ªå…¨å±€ Promiseï¼Œè®©å…¶ä»–è„šæœ¬å¯ä»¥ç­‰å¾…
        window.gameDataPromise = (async function () {
            try {
                // 1. å°è¯•è¯»å–æœ¬åœ°ç¼“å­˜ï¼ˆåŒæ­¥ï¼Œæå¿«ï¼‰
                const localDataRaw = localStorage.getItem("gameData");
                let localData = localDataRaw ? JSON.parse(localDataRaw) : null;

                // 2. å‘èµ·ç½‘ç»œè¯·æ±‚ï¼ˆå¹¶è¡Œå¤„ç†ï¼‰
                // å»ºè®®ï¼šåç«¯æ¥å£ç›´æ¥è¿”å› { version, data }
                const res = await fetch("/api/gamedata");
                const serverData = await res.json();

                // 3. ç‰ˆæœ¬æ¯”å¯¹
                if (!localData || localData.version !== serverData.version) {
                    console.log("[æ•°æ®åŒæ­¥] æ›´æ–°ç¼“å­˜");
                    localStorage.setItem("gameData", JSON.stringify(serverData));
                    localData = serverData;
                }

                // 4. æŒ‚è½½åˆ° window
                window.gameData = localData;
                return localData;
            } catch (err) {
                console.error("[æ•°æ®åŒæ­¥] é”™è¯¯:", err);
                // å…œåº•ç­–ç•¥ï¼šå¦‚æœç½‘ç»œæŒ‚äº†ï¼Œå°è¯•ç”¨æ—§ç¼“å­˜
                if (window.gameData) return window.gameData;
                throw err;
            }
        })(); // ç«‹å³æ‰§è¡Œ

    </script>
</head>
<body>
<!-- é¡¶éƒ¨çŠ¶æ€æ ä¿æŒä¸å˜ -->
<nav class="game-navbar fixed-top d-flex align-items-center justify-content-between text-white shadow-sm px-3">
    <div class="d-flex align-items-center">
        <h5 id="player-name" class="mb-0 fs-6">åŠ è½½ä¸­...</h5>
    </div>
    <div class="d-flex gap-3 align-items-center">
        <span id="player-cash" class="text-success fw-bold small">ğŸ’° $0.00</span>
        <span id="cycle-status" class="badge bg-danger" style="font-size: 0.7rem;">å‘¨æœŸ: --</span>
    </div>
</nav>

<!-- ä¸»å†…å®¹åŒºåŸŸï¼šåº•éƒ¨éœ€è¦ç•™å‡ºå¯¼èˆªæ çš„é«˜åº¦ -->
<div class="main-wrapper">
    <main class="game-content container-fluid pt-5 pb-5 mb-4">
        {% block content %}{% endblock %}
    </main>
</div>

<!-- åº•éƒ¨å¯¼èˆªæ ï¼šæ›¿æ¢åŸæ¥çš„ sidebar -->
<nav class="bottom-nav d-flex justify-content-around align-items-center shadow">
    <a href="/landscape" class="nav-link-custom {% if active_page == 'landscape' %}active{% endif %}" title="æ€»éƒ¨">
        <i class="bi bi-map"></i>
    </a>
    <a href="/exchange" class="nav-link-custom {% if active_page == 'exchange' %}active{% endif %}" title="äº¤æ˜“æ‰€">
        <i class="bi bi-currency-exchange"></i>
    </a>
    <a href="/contract" class="nav-link-custom {% if active_page == 'contracts' %}active{% endif %}" title="åˆåŒ">
        <i class="bi bi-file-earmark-text"></i>
    </a>
    <a href="/inventory" class="nav-link-custom {% if active_page == 'inventory' %}active{% endif %}" title="ä»“åº“">
        <i class="bi bi-box-seam"></i>
    </a>
    <a href="/chat" class="nav-link-custom {% if active_page == 'chat' %}active{% endif %}" title="èŠå¤©">
        <i class="bi bi-chat-dots"></i>
    </a>
    <a href="/economic" class="nav-link-custom {% if active_page == 'economic' %}active{% endif %}" title="ç»æµ">
        <i class="bi bi-graph-up-arrow"></i>
    </a>
    <!-- è®¾ç½®æŒ‰é’®é€šå¸¸æ”¾åœ¨æœ«å°¾ -->
    <a href="#" class="nav-link-custom" data-bs-toggle="modal" data-bs-target="#settingsModal">
        <i class="bi bi-gear"></i>
    </a>
</nav>


<div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5>ç³»ç»Ÿè®¾ç½®</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>ç‰ˆæœ¬: 0.1.0-alpha</p>
                <button class="btn btn-danger w-100">é€€å‡ºå…¬å¸ç®¡ç†</button>
            </div>
        </div>
    </div>
</div>
{% include 'components/toast.html' %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/static/js/global.js"></script>


<script>
    document.addEventListener('DOMContentLoaded', async () => {

        await fetch("/api/player/me").then(async (res) => {
            const player = await res.json()
            document.querySelector("#player-cash").innerText = `$${player.cash.toFixed(2)}`
        }).catch(e => {
            alert(e)
        })
        document.querySelector("#player-name").innerText = getUserInfo().name
        gameWS.subscribe("player", (msg) => {
            const sub_type = msg.sub_type;
            const data = msg.data
            if (sub_type === "update_cash") {
                document.querySelector("#player-cash").innerText = `$${data.cash.toFixed(2)}`
            }
        })

    });

</script>


{% block scripts %}
{% endblock %}
</body>
</html>
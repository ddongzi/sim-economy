<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ company_name }} - SimEcon</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --sidebar-width: 50px;
            --navbar-height: 60px;
        }

        . {
            box-sizing: border-box;
        }

        body, html {
            height: 100%;
            margin: 0;
        }

        /* ä¾§è¾¹æ æ ·å¼ */
        .main-sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            background-color: #2c3e50;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
            z-index: 1030;
            border-right: 1px solid #34495e;
        }

        .nav-item-custom {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #bdc3c7;
            font-size: 1.5rem;
            margin-bottom: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .nav-item-custom:hover {
            background-color: #34495e;
            color: #fff;
        }

        /* ä¸»ä½“å†…å®¹åŒºå®¹å™¨ */
        .main-wrapper {
            margin-left: var(--sidebar-width);
            display: flex;
            flex-direction: column;
            height: 100vh; /* å¼ºåˆ¶å æ»¡æ•´ä¸ªå±å¹•ï¼Œä¸éšå†…å®¹å˜é•¿ */
            overflow: hidden; /* é˜²æ­¢å¤–å±‚å‡ºç°æ»šåŠ¨æ¡ */
        }

        /* é¡¶éƒ¨çŠ¶æ€æ  */
        .game-navbar {
            height: var(--navbar-height);
            background-color: #2c3e50;
            border-bottom: 1px solid #34495e;
            padding: 0 20px;
            flex-shrink: 0; /* å…³é”®ï¼šç¦æ­¢å¯¼èˆªæ è¢«æŒ¤å‹å˜çŸ® */
            /* å…³é”®ä¿®å¤ */
            position: fixed; /* å›ºå®šåœ¨å±å¹•ä¸Š */
            top: 0; /* è´´é¡¶ */
            left: var(--sidebar-width); /* èµ·å§‹ä½ç½® */
            right: 0; /* ç»“æŸä½ç½®ï¼šå±å¹•æœ€å³ä¾§ */
            z-index: 1030; /* ç¡®ä¿åœ¨æ‰€æœ‰å…ƒç´ ä¹‹ä¸Šï¼ŒBootstrap 5 çš„æ ‡å‡†å±‚çº§ */
        }


        /* ç§»é™¤ Bootstrap Container é»˜è®¤å¤–è¾¹è· */
        .game-content {
            flex-grow: 1;
            position: relative;
            padding-top: var(--navbar-height);
            overflow-y: auto; /* åªæœ‰å†…å®¹åŒºåŸŸå¯ä»¥æ»šåŠ¨ */
        }

        /* ä¾§è¾¹æ åº•éƒ¨è®¾ç½® */
        .sidebar-footer {
            margin-top: auto;
            margin-bottom: 20px;
        }


    </style>
</head>
<body>
<aside class="main-sidebar shadow">
    <a href="/landscape" class="nav-item-custom {% if active_page == 'landscape' %}active{% endif %}" title="æ€»éƒ¨å›­åŒº">
        <i class="bi bi-map"></i>
    </a>

    <a href="/exchange" class="nav-item-custom {% if active_page == 'exchange' %}active{% endif %}" title="äº¤æ˜“æ‰€">
        <i class="bi bi-currency-exchange"></i>
    </a>

    <a href="/contract" class="nav-item-custom {% if active_page == 'contracts' %}active{% endif %}" title="åˆåŒæœŸè´§">
        <i class="bi bi-file-earmark-text"></i>
    </a>

    <a href="/inventory" class="nav-item-custom {% if active_page == 'inventory' %}active{% endif %}" title="èµ„äº§ä»“åº“">
        <i class="bi bi-box-seam"></i>
    </a>
    <a href="/chat" class="nav-item-custom {% if active_page == 'inventory' %}active{% endif %}" title="èŠå¤©">
        <i class="bi bi-chat-dots"></i>
    </a>
    <a href="/economic" class="nav-item-custom {% if active_page == 'inventory' %}active{% endif %}"
       title="ç»æµæƒ…å†µå…¨è§ˆ">
        <i class="bi bi-graph-up-arrow"></i>
    </a>
    <a href="/journal" class="nav-item-custom {% if active_page == 'inventory' %}active{% endif %}" title="æ¸¸æˆæ•…äº‹">
        <i class="bi bi-journal-richtext"></i>
    </a>
    <div class="sidebar-footer">
        <a href="#" class="nav-item-custom" title="è®¾ç½®" data-bs-toggle="modal" data-bs-target="#settingsModal">
            <i class="bi bi-gear"></i>
        </a>
    </div>
</aside>

<div class="main-wrapper">
    <nav class="game-navbar d-flex align-items-center justify-content-between text-white shadow-sm">
        <div class="d-flex align-items-center">
            <h5 id="player-name" class="mb-0 ">åŠ è½½ä¸­...</h5>
        </div>
        <div class="d-flex gap-4 align-items-center">
            <span id="user-cash" class="text-success fw-bold">ğŸ’° $0.00</span>
            <span id="cycle-status" class="badge bg-danger">å‘¨æœŸ: --</span>
        </div>
    </nav>

    <main class="game-content">
        {% block content %}{% endblock %}
    </main>
</div>

<div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5>ç³»ç»Ÿè®¾ç½®</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>ç‰ˆæœ¬: 0.1.0-alpha</p>
                <button class="btn btn-danger w-100">é€€å‡ºå…¬å¸ç®¡ç†</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/static/js/global.js"></script>
<script>
    async function initGameData() {
        try {
            // 1. å…ˆè·å–æœåŠ¡å™¨å½“å‰ç‰ˆæœ¬
            const versionRes = await fetch("/api/gamedata");
            const serverVerData = await versionRes.json();
            const serverVersion = serverVerData.version;

            // 2. è¯»å–æœ¬åœ°ç¼“å­˜
            const localDataRaw = localStorage.getItem("gameData");
            let localData = localDataRaw ? JSON.parse(localDataRaw) : null;

            // 3. åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°ä¸‹è½½ï¼ˆæ— ç¼“å­˜ æˆ– ç‰ˆæœ¬ä¸åŒ¹é…ï¼‰
            if (!localData || localData.version !== serverVersion) {
                console.log(`[æ•°æ®åŒæ­¥] ç¼“å­˜è¿‡æœŸæˆ–ä¸å­˜åœ¨ (${localData?.version || 'æ— '} -> ${serverVersion})`);

                // æŠ“å–å…¨é‡å»ºç­‘/å…ƒæ•°æ®
                const dataRes = await fetch("/api/gamedata");
                const data = await dataRes.json();

                localData = data;
                // å†™å…¥æœ¬åœ°å­˜å‚¨
                localStorage.setItem("gameData", JSON.stringify(data));
                console.log("[æ•°æ®åŒæ­¥] æœåŠ¡å™¨æ•°æ®å·²åŒæ­¥å¹¶å­˜æ¡£");
            } else {
                console.log(`[æ•°æ®åŒæ­¥] ç¼“å­˜æœ‰æ•ˆ (Version: ${serverVersion})`);
            }

            // 4. æ— è®ºæ¥æºæ˜¯å“ªï¼Œæœ€ç»ˆéƒ½æŒ‚è½½åˆ° window å¯¹è±¡ä¾›å…¨å±€ä½¿ç”¨
            window.gameData = localData;

        } catch (err) {
            console.error("[æ•°æ®åŒæ­¥] è‡´å‘½é”™è¯¯:", err);
            // å®¹é”™å¤„ç†ï¼šå¦‚æœå®Œå…¨å¤±è´¥ï¼Œè‡³å°‘ä¿è¯ window.gameData ä¸ä¸º undefined
            window.gameData = window.gameData || {buildings: []};
        }
        document.dispatchEvent(new Event("gameInitDone"))
    }

    document.addEventListener('DOMContentLoaded', async () => {
        await initGameData();
    });
</script>
<script>
    /**
     *  å›¾æ ‡æ¸²æŸ“å‡½æ•°
     * @param {string} iconName - å›¾æ ‡ç±»åæˆ–æ ‡è¯†ç¬¦
     * @param {string} defaultIcon - ç¼ºçœæ—¶æ˜¾ç¤ºçš„ Emoji æˆ–ç±»å
     * @returns {string} - å®Œæ•´çš„ HTML å­—ç¬¦ä¸²
     */
    function renderIcon(iconName, defaultIcon = 'ğŸ—ï¸') {
        // å¦‚æœæ²¡æœ‰ä¼ å…¥ iconNameï¼Œç›´æ¥è¿”å›é»˜è®¤å€¼
        if (!iconName || iconName.trim() === "") {
            return `<span>${defaultIcon}</span>`;
        }

        // å¦‚æœ iconName çœ‹èµ·æ¥åƒç±»åï¼ˆä¸åŒ…å« HTML æ ‡ç­¾ï¼‰ï¼Œåˆ™å°è£…æˆ <i>
        // é€»è¾‘ï¼šå¦‚æœ iconName é‡Œæœ‰ 'bi-' æˆ– 'fa-'ï¼Œåˆ¤å®šä¸ºå›¾æ ‡åº“ç±»å
        if (iconName.includes('bi-') || iconName.includes('fa-')) {
            return `<i class="${iconName} me-2"></i>`;
        }

        // å¦åˆ™ï¼Œå®ƒå¯èƒ½æœ¬èº«å°±æ˜¯ä¸€ä¸ª Emoji
        return `<span class="me-2">${iconName}</span>`;
    }

</script>
<script>
    async function updatePerson() {
        const res = await fetch("/api/player/me");
        const player = await res.json();
        document.querySelector("#user-cash").innerHTML = `$${player.cash.toLocaleString()}`;
        document.querySelector("#player-name").innerText = player.name;
    }

    updatePerson()
</script>
{% block scripts %}
{% endblock %}
</body>
</html>
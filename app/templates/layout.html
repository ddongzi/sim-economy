<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ company_name }} - SimEcon</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it-texmath/texmath.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script type="module">
        import {pipeline} from 'https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.8.1';
        // 把它挂载到 window 对象，方便你在其他脚本里调用
        window.TransformerAI = {pipeline};
    </script>
    <style>
        :root {
            --navbar-height: 50px;
        }

        . {
            box-sizing: border-box;
        }

        body, html {
            height: 100%;
            margin: 0;
        }

        /* 主体内容区容器 */
        .main-wrapper {
            margin-left: 0 !important; /* 取消原侧边栏留白 */
            width: 100%;
            display: flex;
            flex-direction: column;
            height: 100vh; /* 强制占满整个屏幕，不随内容变长 */
            overflow: hidden; /* 防止外层出现滚动条 */
        }

        /* 顶部状态栏 */
        .game-navbar {
            height: var(--navbar-height);
            background-color: #2c3e50;
            border-bottom: 1px solid #34495e;
            padding: 0 20px;
            flex-shrink: 0; /* 关键：禁止导航栏被挤压变矮 */
            /* 关键修复 */
            position: fixed; /* 固定在屏幕上 */
            top: 0; /* 贴顶 */
            left: 0;
            right: 0; /* 结束位置：屏幕最右侧 */
            z-index: 1030; /* 确保在所有元素之上，Bootstrap 5 的标准层级 */
        }

        /* 导航项样式 */
        .nav-link-custom {
            color: #6c757d;
            text-decoration: none;
            font-size: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex: 1; /* 均分空间 */
        }

        /* 激活状态：变色并带有小圆点或发光效果 */
        .nav-link-custom.active {
            color: #0d6efd;
            position: relative;
        }

        .nav-link-custom.active::after {
            content: '';
            position: absolute;
            bottom: 5px;
            width: 5px;
            height: 5px;
            background: #0d6efd;
            border-radius: 50%;
        }

        .nav-link-custom:hover {
            color: #0d6efd;
            transform: translateY(-2px);
        }

        /* 底部导航栏容器 */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--navbar-height);
            background: #ffffff;
            border-top: 1px solid #dee2e6;
            z-index: 1030;
            padding-bottom: env(safe-area-inset-bottom); /* 适配 2026 手机全面屏底边 */
        }

    </style>
    <script>
        const md = window.markdownit({
            html: true,
            breaks: true
        }).use(texmath, {
            engine: katex,
            delimiters: 'dollars'
        });

    </script>
    <style>
        /* 让进度条变化像水流一样顺滑 */
        #solar-wave {
            transition: width 3s ease-in-out;
        }

        /* 降低跑马灯的亮度，保护视力 */
        #news-scroll {
            color: #8a857a !important; /* 一种更温和的深灰色 */
            /* 将 10s 改为 30s 或更高，数字越大速度越慢 */

        }
    </style>
    <style>
        .news-ticker-content {
            display: inline-block;
            white-space: nowrap;
            padding-left: 100%; /* 从最右侧开始 */
            animation: ticket-scroll 60s linear infinite; /* 30秒一圈，非常缓慢 */
            line-height: 20px;
            font-size: 0.75rem;
        }

        /* 鼠标悬停时暂停，方便阅读 */
        .news-ticker-content:hover {
            animation-play-state: paused;
        }

        @keyframes ticket-scroll {
            0% {
                transform: translateX(0);
            }
            100% {
                transform: translateX(-100%);
            }
        }

    </style>

</head>
<body>
<!-- 顶部状态栏保持不变 -->
<nav class="navbar navbar-expand-lg fixed-top py-0 border-bottom border-warning border-opacity-25 shadow-sm"
     style="height: 52px; background: #F7F3E9 !important;">
    <div class="container-fluid px-4 h-100 font-monospace">

        <div class="d-flex align-items-center pe-4 border-end border-dark border-opacity-10 h-100">
            <i class="bi bi-person-circle text-warning me-2 fs-5"></i>
            <span id="player-name" class="fw-bold text-dark small">JACK</span>
        </div>

        <div class="flex-grow-1 d-flex justify-content-center align-items-center gap-5">

            <div class="d-flex align-items-center gap-2" data-bs-toggle="tooltip"
                 title="太阳活动强度，0-5">
                <i class="bi bi-sun-fill text-warning fs-6"></i>
                <span id="solar-index" class="fw-bold text-dark small" style="min-width: 40px;">1.42</span>
                <div class="bg-warning bg-opacity-20 rounded-pill" style="width: 30px; height: 3px;">
                    <div id="solar-wave" class="progress-bar bg-warning opacity-75 w-75"></div>
                </div>
            </div>

            <div class="bg-white bg-opacity-50 border border-warning border-opacity-20 rounded-pill px-3 py-1 d-flex align-items-center"
                 style="width: 320px;">
                <i class="bi bi-broadcast text-warning me-2 small" data-bs-toggle="tooltip"
                   title="宇宙预警信息"></i>
                <div class="flex-grow-1 position-relative overflow-hidden" style="height: 20px;">
                    <div id="news-scroll" class="news-ticker-content text-muted small">
                        [实时观测] 太阳活动平稳 ● 数据链路同步中 ● 月影正向西偏移 ●
                    </div>
                </div>
            </div>

            <div class="d-flex align-items-center gap-2" data-bs-toggle="tooltip"
                 title="地月距离">
                <i class="bi bi-moon-stars-fill text-warning opacity-50 fs-6"></i>
                <span id="lunar-dist" class="text-dark fw-bold small">36.3w km</span>
            </div>
        </div>

        <div class="d-flex align-items-center ps-4 border-start border-dark border-opacity-10 gap-4">
            <div class="d-flex align-items-center gap-2">
                <i class="bi bi-wallet2 text-success opacity-75"></i>
                <span id="player-cash" class="text-dark fw-bold small">$124,500.80</span>
            </div>
            <div class="d-flex align-items-center gap-2">
                <i class="bi bi-graph-up-arrow text-warning"></i>
                <span id="cycle-status" class="text-dark fw-bold small">88.5</span>
            </div>
        </div>
    </div>
</nav>
<!-- 主内容区域：底部需要留出导航栏的高度 -->
<main class="container-fluid overflow-hidden pt-5 pb-5">
    {% block content %}{% endblock %}
</main>

<!-- 底部导航栏：替换原来的 sidebar -->
<nav class="bottom-nav fixed-bottom d-flex justify-content-around align-items-center shadow">
    <a href="/landscape" class="nav-link-custom {% if active_page == 'landscape' %}active{% endif %}" title="总部">
        <i class="bi bi-map"></i>
    </a>
    <a href="/exchange" class="nav-link-custom {% if active_page == 'exchange' %}active{% endif %}" title="交易所">
        <i class="bi bi-currency-exchange"></i>
    </a>
    <a href="/contract" class="nav-link-custom {% if active_page == 'contracts' %}active{% endif %}" title="合同">
        <i class="bi bi-file-earmark-text"></i>
    </a>
    <a href="/inventory" class="nav-link-custom {% if active_page == 'inventory' %}active{% endif %}" title="仓库">
        <i class="bi bi-box-seam"></i>
    </a>
    <a href="/chat" class="nav-link-custom {% if active_page == 'chat' %}active{% endif %}" title="聊天">
        <i class="bi bi-chat-dots"></i>
    </a>
    <a href="/economic" class="nav-link-custom {% if active_page == 'economic' %}active{% endif %}" title="经济">
        <i class="bi bi-graph-up-arrow"></i>
    </a>
    <a href="/journal" class="nav-link-custom {% if active_page == 'journal' %}active{% endif %}" title="经济">
        <i class="bi bi-journal"></i>
    </a>
    <a href="/personal/" class="nav-link-custom {% if active_page == 'personal' %}active{% endif %}" title="我的">
        <i class="bi bi-person"></i>
    </a>
</nav>


<div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5>系统设置</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>版本: 0.1.0-alpha</p>
                <button class="btn btn-danger w-100">退出公司管理</button>
            </div>
        </div>
    </div>
</div>
{% include 'components/toast.html' %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/static/js/global.js"></script>


<script>
    document.addEventListener('DOMContentLoaded', async () => {

        await fetch("/api/player/me").then(async (res) => {
            const player = await res.json()
            document.querySelector("#player-cash").innerText = `$${player.cash.toFixed(2)}`
        }).catch(e => {
            alert(e)
        })
        document.querySelector("#player-name").innerText = getUserInfo().name
        gameWS.subscribe("player", (msg) => {
            const sub_type = msg.sub_type;
            const data = msg.data
            if (sub_type === "update_cash") {
                document.querySelector("#player-cash").innerText = `$${data.cash.toFixed(2)}`
            }
        })

    });

</script>
<script>
    // 在 render 函数中给数值加一点微小的视觉抖动
    function applyGentleJitter(elementId, baseValue) {
        const el = document.getElementById(elementId);
        setInterval(() => {
            const jitter = (Math.random() - 0.5) * 0.001;
            el.innerText = (parseFloat(baseValue) + jitter).toFixed(2);
        }, 500);
    }

    let summarizer = null;
    /**
     * 真实深空数据同步引擎
     */
    const RealSpaceAPI = {
            // 1. 获取真实太阳与地磁活动 (NOAA 实时数据)
            async syncSolarActivity() {
                try {
                    // 获取 NOAA 的实时等级 (R:无线电, S:太阳辐射, G:地磁)
                    const response = await fetch('https://services.swpc.noaa.gov/products/noaa-scales.json');
                    const data = await response.json();
                    const today = data[0]
                    console.log(today);

                    // 我们取 R (无线电干扰) 作为你的 Solar Index
                    const radioScale = parseInt(today.R.Scale); // 0-5 级
                    const solarVal = (1.0 + (radioScale * 0.2)).toFixed(2); // 映射到 1.0-2.0 范围

                    document.getElementById('solar-index').innerText = solarVal;

                    // 更新进度条宽度
                    const percentage = (radioScale / 5) * 100 + 20;
                    document.getElementById('solar-wave').style.width = percentage + "%";

                    return radioScale;
                } catch (error) {
                    console.error("无法同步太阳数据:", error);
                    return 0;
                }
            },


            // 3. 计算此时此刻真实的月球距离 (精确到KM)
            syncLunarDistance() {
                // 使用简化的月球轨道偏心率公式，基于 Unix 时间戳计算
                const now = new Date();
                const t = (now.getTime() / 1000 / 86400) + 2440587.5;
                const dist = 385000.56 - 20905.35 * Math.cos((134.963 + 13.064993 * (t - 2451545.0)) * Math.PI / 180);

                // 国际化处理：使用本地化数字格式 (例如: 384,400 km)
                const formattedDist = Math.floor(dist).toLocaleString('en-US');
                document.getElementById('lunar-dist').innerText = `${formattedDist} km`;
            }
            ,

            // 4. 定时轮询逻辑
            init() {
                // 初始同步
                this.syncSolarActivity();
                this.syncLunarDistance();

                // 太阳数据和消息每 60 分钟更新一次（API 限制，不建议太快）
                setInterval(() => this.syncSolarActivity(), 1000 * 60 * 60);
                // 月球距离每秒都在变
                setInterval(() => this.syncLunarDistance(), 1000);
            }
        }
    ;

    // 页面加载完成后启动
    document.addEventListener('DOMContentLoaded', () => RealSpaceAPI.init());
</script>

{% block scripts %}
{% endblock %}
</body>
</html>